{"version":3,"file":"edit-CavjcPLw.js","sources":["../../src/pages/product/edit.vue"],"sourcesContent":["<template>\n  <el-drawer v-model=\"visible\" :title=\"form.id > 0 ? '编辑产品' : '新增产品'\" size=\"50%\">\n    <div v-loading=\"loading\" element-loading-text=\"加载中...\">\n      <el-form :model=\"form\" :rules=\"rules\" ref=\"formRef\" label-width=\"150px\">\n        <!-- 基本信息 -->\n        <el-divider content-position=\"left\">基本信息</el-divider>\n        \n        <el-form-item label=\"产品名称\" prop=\"product_name\">\n          <el-input v-model=\"form.product_name\" placeholder=\"请输入产品名称\" />\n        </el-form-item>\n        \n        \n        <el-form-item label=\"排序\" prop=\"sort\">\n          <el-input-number v-model=\"form.sort\" :min=\"0\" :max=\"999999\" placeholder=\"数值越大越靠前\" />\n        </el-form-item>\n        \n        <el-form-item label=\"状态\" prop=\"status\">\n          <el-switch v-model=\"form.status\" :active-value=\"1\" :inactive-value=\"0\" />\n        </el-form-item>\n\n        <!-- 费率配置 -->\n        <el-divider content-position=\"left\">费率配置</el-divider>\n        \n        <el-form-item label=\"默认费率\" prop=\"default_rate\">\n          <el-input v-model=\"form.default_rate\" placeholder=\"请输入默认费率\">\n            <template #append>%</template>\n          </el-input>\n          <div class=\"form-tip\">例如：1.5 表示 1.5%</div>\n        </el-form-item>\n\n        <!-- 其他信息 -->\n        <el-divider content-position=\"left\">其他信息</el-divider>\n        \n        <el-form-item label=\"备注\" prop=\"remark\">\n          <el-input \n            v-model=\"form.remark\" \n            type=\"textarea\" \n            placeholder=\"请输入备注信息\"\n            :rows=\"3\"\n          />\n        </el-form-item>\n\n        <el-form-item>\n          <el-button type=\"primary\" @click=\"handleSubmit\" :loading=\"loading\">提交</el-button>\n          <el-button @click=\"visible = false\">取消</el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n  </el-drawer>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, watch } from 'vue'\nimport { ElMessage, ElForm } from 'element-plus'\n\nimport {addProduct, editProduct, getProductDetail} from \"@/api/product.ts\";\n\nconst visible = ref(false)\nconst formRef = ref<InstanceType<typeof ElForm>>()\nconst loading = ref(false)\n\nconst form = ref({\n  id: 0,\n  product_name: \"\",\n  external_code: \"\",\n  sort: 0,\n  status: 1,\n  default_rate: 0,\n  remark: \"\",\n})\n\nconst emit = defineEmits<{\n  (event: 'refresh'): void\n}>()\n\n\n// 定义规则\nconst rules = ref({\n  product_name: [{ required: true, message: '请输入产品名称', trigger: 'blur' }],\n  sort: [{ required: true, message: '请输入排序值', trigger: 'blur' }],\n  default_rate: [\n    { required: false, message: '请输入默认费率', trigger: 'blur' },\n    { \n      validator: (_rule: any, value: any, callback: any) => {\n        if (value && (isNaN(Number(value)) || Number(value) < 0 || Number(value) > 100)) {\n          callback(new Error('费率范围0-100%'))\n        } else {\n          callback()\n        }\n      }, \n      trigger: 'blur' \n    }\n  ],\n})\n\nconst open = async (data: any = {}) => {\n  // 先重置表单\n  resetForm()\n  loading.value = true\n  \n  try {\n    // 确保 data 不为 null 或 undefined\n    const safeData = data || {}\n    let merged: any = { ...safeData }\n    \n    // 检查是否有有效的 id 且大于 0\n    if (safeData && safeData.id && typeof safeData.id === 'number' && safeData.id > 0) {\n      // 编辑模式：从详情获取数据\n      try {\n        const res = await getProductDetail('/api/v1/admin/product/detail', safeData.id)\n        if (res.status && res.data) {\n          merged = { ...res.data }\n        } else {\n          ElMessage.error('获取产品详情失败')\n          return\n        }\n      } catch (error) {\n        ElMessage.error('获取产品详情失败')\n        return\n      }\n    }\n\n    // 只更新有值的字段\n    Object.keys(merged).forEach(key => {\n      if (merged[key] !== undefined && merged[key] !== null && merged[key] !== '') {\n        (form.value as any)[key] = merged[key]\n      }\n    })\n    \n    // 如果是新增模式，确保表单有正确的默认值\n    if (!safeData || !safeData.id || safeData.id <= 0) {\n      form.value.id = 0\n      form.value.status = 1\n      form.value.sort = 0\n      form.value.default_rate = 0\n      form.value.remark = \"\"\n      // 对接编号由后台自动生成\n      form.value.external_code = \"\"\n  } else {\n      // 编辑模式：转换为百分比显示\n      if (merged.default_rate_bp) {\n        form.value.default_rate = parseFloat(merged.default_rate_bp.toFixed(2))\n      }\n    }\n    visible.value = true\n  } catch (error) {\n    ElMessage.error('加载数据失败')\n  } finally {\n    loading.value = false\n  }\n}\n\nconst handleSubmit = async () => {\n  try {\n    await formRef.value?.validate()\n\n    // 准备提交数据\n    const submitData: any = { ...form.value }\n    \n    // 将百分比转换为存储格式\n    if (submitData.default_rate) {\n      submitData.default_rate_bp = parseFloat(submitData.default_rate.toString())\n    } else {\n      submitData.default_rate_bp = 0\n    }\n    \n    // 移除前端字段和不需要的字段\n    delete submitData.default_rate\n    delete submitData.id\n    delete submitData.external_code\n\n    loading.value = true\n    let res: any\n    if (form.value.id > 0) {\n      res = await editProduct('/api/v1/admin/product/edit', submitData)\n    } else {\n      res = await addProduct('/api/v1/admin/product/add', submitData)\n    }\n\n    if (res.status) {\n      ElMessage.success(res.message || '操作成功')\n      emit('refresh')\n      visible.value = false\n    } else {\n      ElMessage.error(res.message || '操作失败')\n    }\n  } catch (error) {\n    ElMessage.error('提交失败，请检查表单信息')\n  } finally {\n    loading.value = false\n  }\n}\n\n// 重置表单数据\nconst resetForm = () => {\n  form.value = {\n    id: 0,\n    product_name: \"\",\n    external_code: \"\", // 由后台自动生成\n    sort: 0,\n    status: 1,\n    default_rate: 0,\n    remark: \"\",\n  }\n}\n\n// 监听 visible 变化，关闭时重置表单\nwatch(visible, (newVal, oldVal) => {\n  // 只有在从 true 变为 false 时才重置表单\n  if (oldVal === true && newVal === false) {\n    resetForm()\n  }\n})\n\ndefineExpose({ open })\n</script>\n\n<style lang=\"scss\" scoped>\n.form-tip {\n  font-size: 12px;\n  color: #999;\n  margin-top: 4px;\n}\n</style>"],"names":["visible","ref","formRef","loading","form","emit","__emit","rules","_rule","value","callback","open","data","resetForm","safeData","merged","res","getProductDetail","ElMessage","key","handleSubmit","_a","submitData","editProduct","addProduct","watch","newVal","oldVal","__expose","_createBlock","_component_el_drawer","$event","_withDirectives","_openBlock","_createElementBlock","_hoisted_1","_createVNode","_unref","ElForm","_component_el_divider","_cache","_component_el_form_item","_component_el_input","_component_el_input_number","_component_el_switch","_createElementVNode","_component_el_button"],"mappings":"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"}