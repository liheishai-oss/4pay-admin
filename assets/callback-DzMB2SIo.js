import{s as Y,_ as pe,g as v,h as G,L as ve,aK as fe,c as J,e as l,Q as X,a as e,w as a,t as d,au as he,i as x,D as f,aL as ge,k as ye,E as be,a1 as we,o as w,ar as ke,at as Me,u,aM as N,b as Ce,aN as Se,S as Q,q as Ee,n as m,a4 as Ve,aO as ze,p as Te,O as xe,W as Qe,j as q,aP as Ye,a8 as De,x as Pe,y as Ue,z as Be,aH as Le,V as He,aQ as Ne,P as qe,aR as Ie,aS as Re}from"./index-Dwi2X-zo.js";/* empty css                *//* empty css                   *//* empty css               *//* empty css                          *//* empty css                     *//* empty css                 */const Oe=(g={})=>Y({url:"/api/v1/admin/merchant-callback-monitor/merchant-stats",method:"get",params:g}),$e=g=>Y({url:"/api/v1/admin/merchant-callback-monitor/notify-logs",method:"get",params:g}),Fe=g=>Y({url:"/api/v1/admin/merchant-callback-monitor/reset-circuit-breaker",method:"post",data:g}),je=()=>Y({url:"/api/v1/admin/merchant-callback-monitor/queue-status",method:"get"}),Ae={class:"merchant-callback-monitor"},Ke={class:"floating-time-selector"},We={class:"time-range-display"},Ge={class:"system-status-cards"},Je={class:"card-header"},Xe={class:"queue-status"},Ze={class:"queue-overview"},et={class:"overview-item"},tt={class:"overview-icon notify"},at={class:"overview-content"},lt={class:"overview-count"},st={class:"overview-item"},ot={class:"overview-icon retry"},nt={class:"overview-content"},rt={class:"overview-count"},it={class:"overview-item"},ut={class:"overview-icon delayed"},ct={class:"overview-content"},dt={class:"overview-count"},_t={class:"card-header"},mt={class:"merchant-overview"},pt={class:"merchant-stat-card"},vt={class:"stat-icon total"},ft={class:"stat-content"},ht={class:"merchant-stat-card"},gt={class:"stat-icon normal"},yt={class:"stat-content"},bt={class:"merchant-stat-card"},wt={class:"stat-icon slow"},kt={class:"stat-content"},Mt={class:"merchant-stat-card"},Ct={class:"stat-icon circuit"},St={class:"stat-content"},Et={class:"merchant-details"},Vt={class:"callback-url-container"},zt=["onClick","title"],Tt={class:"card-header"},xt={class:"header-actions"},Qt={key:0,class:"filters"},Yt={class:"pagination"},Dt={__name:"callback",setup(g){const h=v([]),I=v([]),k=v({notifyQueue:0,retryQueue:0,delayedQueue:0,lastUpdate:""}),M=v({totalMerchants:0,normalMerchants:0,slowMerchants:0,circuitBreakerMerchants:0}),C=v("1m"),E=v(!1),V=v(!1),D=v(!1),P=v(!1),c=G({order_no:"",status:"",merchant_key:"",start_time:"",end_time:""}),_=G({currentPage:1,pageSize:20,total:0});let U=null;const Z=()=>{z(),y(),T()},ee=()=>({"5s":"最近5秒","1m":"最近1分钟","5m":"最近5分钟","10m":"最近10分钟","1h":"最近1小时","1d":"最近1天"})[C.value]||"最近1分钟",z=async()=>{E.value=!0;try{const s={time_range:C.value},t=await Oe(s);t.code===200&&(h.value=t.data.merchants||[],te())}catch(s){f.error("获取商户统计失败"),console.error("获取商户统计失败:",s)}finally{E.value=!1}},te=()=>{Array.isArray(h.value)||(console.warn("merchantStats.value 不是数组:",h.value),h.value=[]);const s={totalMerchants:h.value.length,normalMerchants:0,slowMerchants:0,circuitBreakerMerchants:0};h.value.forEach(t=>{switch(t.status){case"normal":s.normalMerchants++;break;case"slow":s.slowMerchants++;break;case"circuit_breaker":s.circuitBreakerMerchants++;break}}),M.value=s},T=async()=>{D.value=!0;try{const s=await je();s.code===200&&(k.value={notifyQueue:s.data.notifyQueue||0,retryQueue:s.data.retryQueue||0,delayedQueue:s.data.delayedQueue||0,lastUpdate:s.data.lastUpdate||""},console.log("队列状态更新:",k.value))}catch(s){f.error("获取队列状态失败"),console.error("获取队列状态失败:",s)}finally{D.value=!1}},y=async()=>{V.value=!0;try{const s={page:_.currentPage,limit:_.pageSize,time_range:C.value,...c},t=await $e(s);t.code===200&&(I.value=t.data.list,_.total=t.data.total)}catch(s){f.error("获取通知日志失败"),console.error("获取通知日志失败:",s)}finally{V.value=!1}},R=()=>{_.currentPage=1,y()},ae=()=>{Object.assign(c,{order_no:"",status:"",merchant_key:"",start_time:"",end_time:""}),R()},le=async s=>{try{await Re.confirm("确定要重置该商户的熔断器吗？","确认重置",{type:"warning"});const t=await Fe({merchant_key:s});t.code===200?(f.success("熔断器重置成功"),z()):f.error(t.message||"重置失败")}catch(t){t!=="cancel"&&(f.error("重置熔断器失败"),console.error("重置熔断器失败:",t))}},se=s=>{_.pageSize=s,_.currentPage=1,y()},oe=s=>{_.currentPage=s,y()},ne=s=>({normal:"success",slow:"warning",circuit_breaker:"danger"})[s]||"info",re=s=>({normal:"正常",slow:"慢响应",circuit_breaker:"熔断"})[s]||"未知",ie=s=>({success:"success",failed:"danger",pending:"warning"})[s]||"info",ue=s=>({success:"成功",failed:"失败",pending:"处理中"})[s]||"未知",ce=s=>{console.log("查看商户详情:",s)},O=async s=>{if(s)try{await navigator.clipboard.writeText(s),f.success("回调地址已复制到剪贴板")}catch{const r=document.createElement("textarea");r.value=s,document.body.appendChild(r),r.select();try{document.execCommand("copy"),f.success("回调地址已复制到剪贴板")}catch{f.error("复制失败，请手动复制")}document.body.removeChild(r)}};return ve(()=>{z(),y(),T(),U=setInterval(()=>{T()},3e4)}),fe(()=>{U&&clearInterval(U)}),(s,t)=>{const r=Me,B=ke,de=ge,i=ye,p=Ee,L=we,S=Ce,$=be,n=Qe,F=De,j=xe,A=Be,b=Ue,K=Le,_e=Pe,me=qe,W=he;return w(),J("div",Ae,[l("div",Ke,[e(de,{content:"选择监控时间范围",placement:"left"},{default:a(()=>[e(B,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=o=>C.value=o),onChange:Z,placeholder:"时间范围",size:"small",class:"time-range-select"},{default:a(()=>[e(r,{label:"最近5秒",value:"5s"}),e(r,{label:"最近1分钟",value:"1m"}),e(r,{label:"最近5分钟",value:"5m"}),e(r,{label:"最近10分钟",value:"10m"}),e(r,{label:"最近1小时",value:"1h"}),e(r,{label:"最近1天",value:"1d"})]),_:1},8,["modelValue"])]),_:1}),l("div",We,[e(i,null,{default:a(()=>[e(u(N))]),_:1}),l("span",null,d(ee()),1)])]),l("div",Ge,[e($,{gutter:20},{default:a(()=>[e(S,{span:24},{default:a(()=>[e(L,{class:"status-card"},{header:a(()=>[l("div",Je,[t[10]||(t[10]=l("span",null,"队列状态",-1)),e(p,{onClick:T,loading:D.value,size:"small"},{default:a(()=>[e(i,null,{default:a(()=>[e(u(Q))]),_:1}),t[9]||(t[9]=m(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:a(()=>[l("div",Xe,[l("div",Ze,[l("div",et,[l("div",tt,[e(i,null,{default:a(()=>[e(u(Se))]),_:1})]),l("div",at,[t[11]||(t[11]=l("div",{class:"overview-title"},"待通知队列",-1)),l("div",lt,d(k.value.notifyQueue||0),1)])]),l("div",st,[l("div",ot,[e(i,null,{default:a(()=>[e(u(Q))]),_:1})]),l("div",nt,[t[12]||(t[12]=l("div",{class:"overview-title"},"重试队列",-1)),l("div",rt,d(k.value.retryQueue||0),1)])]),l("div",it,[l("div",ut,[e(i,null,{default:a(()=>[e(u(N))]),_:1})]),l("div",ct,[t[13]||(t[13]=l("div",{class:"overview-title"},"延迟队列",-1)),l("div",dt,d(k.value.delayedQueue||0),1)])])])])]),_:1})]),_:1})]),_:1})]),X((w(),x(L,{class:"merchant-stats-card"},{header:a(()=>[l("div",_t,[t[15]||(t[15]=l("span",null,"商户状态统计",-1)),e(p,{onClick:z,loading:E.value},{default:a(()=>[e(i,null,{default:a(()=>[e(u(Q))]),_:1}),t[14]||(t[14]=m(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:a(()=>[l("div",mt,[e($,{gutter:20},{default:a(()=>[e(S,{span:6},{default:a(()=>[l("div",pt,[l("div",vt,[e(i,null,{default:a(()=>[e(u(Ve))]),_:1})]),l("div",ft,[l("h3",null,d(M.value.totalMerchants||0),1),t[16]||(t[16]=l("p",null,"总商户数",-1))])])]),_:1}),e(S,{span:6},{default:a(()=>[l("div",ht,[l("div",gt,[e(i,null,{default:a(()=>[e(u(ze))]),_:1})]),l("div",yt,[l("h3",null,d(M.value.normalMerchants||0),1),t[17]||(t[17]=l("p",null,"正常商户",-1))])])]),_:1}),e(S,{span:6},{default:a(()=>[l("div",bt,[l("div",wt,[e(i,null,{default:a(()=>[e(u(N))]),_:1})]),l("div",kt,[l("h3",null,d(M.value.slowMerchants||0),1),t[18]||(t[18]=l("p",null,"慢响应商户",-1))])])]),_:1}),e(S,{span:6},{default:a(()=>[l("div",Mt,[l("div",Ct,[e(i,null,{default:a(()=>[e(u(Te))]),_:1})]),l("div",St,[l("h3",null,d(M.value.circuitBreakerMerchants||0),1),t[19]||(t[19]=l("p",null,"熔断商户",-1))])])]),_:1})]),_:1})]),l("div",Et,[e(j,{data:h.value,stripe:""},{default:a(()=>[e(n,{prop:"merchant_name",label:"商户名称","min-width":"150"},{default:a(({row:o})=>[m(d(o.merchant_name||o.merchant_key),1)]),_:1}),e(n,{prop:"merchant_key",label:"商户标识","min-width":"120"}),e(n,{prop:"notify_url",label:"回调地址","min-width":"200","show-overflow-tooltip":""},{default:a(({row:o})=>[l("div",Vt,[l("span",{class:"callback-url",onClick:H=>O(o.notify_url),title:o.notify_url},d(o.notify_url||"-"),9,zt),o.notify_url?(w(),x(p,{key:0,onClick:H=>O(o.notify_url),type:"text",size:"small",class:"copy-btn",title:"复制回调地址"},{default:a(()=>[e(i,null,{default:a(()=>[e(u(Ye))]),_:1})]),_:1},8,["onClick"])):q("",!0)])]),_:1}),e(n,{prop:"status",label:"状态",width:"100"},{default:a(({row:o})=>[e(F,{type:ne(o.status)},{default:a(()=>[m(d(re(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"failed_requests",label:"失败数",width:"80"}),e(n,{prop:"avg_response_time",label:"平均响应时间",width:"120"},{default:a(({row:o})=>[m(d(o.avg_response_time||0)+"ms ",1)]),_:1}),e(n,{label:"操作",width:"120"},{default:a(({row:o})=>[o.status==="circuit_breaker"?(w(),x(p,{key:0,onClick:H=>le(o.merchant_key),type:"warning",size:"small"},{default:a(()=>[...t[20]||(t[20]=[m(" 重置熔断器 ",-1)])]),_:1},8,["onClick"])):q("",!0),e(p,{onClick:H=>ce(o),type:"primary",size:"small"},{default:a(()=>[...t[21]||(t[21]=[m(" 查看详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1})),[[W,E.value]]),e(L,{class:"notify-logs-card"},{header:a(()=>[l("div",Tt,[t[24]||(t[24]=l("span",null,"通知日志",-1)),l("div",xt,[e(p,{onClick:y,loading:V.value},{default:a(()=>[e(i,null,{default:a(()=>[e(u(Q))]),_:1}),t[22]||(t[22]=m(" 刷新 ",-1))]),_:1},8,["loading"]),e(p,{onClick:t[1]||(t[1]=o=>P.value=!P.value)},{default:a(()=>[e(i,null,{default:a(()=>[e(u(Ie))]),_:1}),t[23]||(t[23]=m(" 筛选 ",-1))]),_:1})])])]),default:a(()=>[P.value?(w(),J("div",Qt,[e(_e,{model:c,inline:""},{default:a(()=>[e(b,{label:"订单号"},{default:a(()=>[e(A,{modelValue:c.order_no,"onUpdate:modelValue":t[2]||(t[2]=o=>c.order_no=o),placeholder:"请输入订单号",clearable:""},null,8,["modelValue"])]),_:1}),e(b,{label:"状态"},{default:a(()=>[e(B,{modelValue:c.status,"onUpdate:modelValue":t[3]||(t[3]=o=>c.status=o),placeholder:"请选择状态",clearable:""},{default:a(()=>[e(r,{label:"全部",value:""}),e(r,{label:"成功",value:"success"}),e(r,{label:"失败",value:"failed"}),e(r,{label:"处理中",value:"pending"})]),_:1},8,["modelValue"])]),_:1}),e(b,{label:"商户标识"},{default:a(()=>[e(A,{modelValue:c.merchant_key,"onUpdate:modelValue":t[4]||(t[4]=o=>c.merchant_key=o),placeholder:"请输入商户标识",clearable:""},null,8,["modelValue"])]),_:1}),e(b,{label:"开始时间"},{default:a(()=>[e(K,{modelValue:c.start_time,"onUpdate:modelValue":t[5]||(t[5]=o=>c.start_time=o),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),e(b,{label:"结束时间"},{default:a(()=>[e(K,{modelValue:c.end_time,"onUpdate:modelValue":t[6]||(t[6]=o=>c.end_time=o),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),e(b,null,{default:a(()=>[e(p,{type:"primary",onClick:R},{default:a(()=>[e(i,null,{default:a(()=>[e(u(He))]),_:1}),t[25]||(t[25]=m(" 搜索 ",-1))]),_:1}),e(p,{onClick:ae},{default:a(()=>[e(i,null,{default:a(()=>[e(u(Ne))]),_:1}),t[26]||(t[26]=m(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])])):q("",!0),X((w(),x(j,{data:I.value,stripe:""},{default:a(()=>[e(n,{prop:"id",label:"ID",width:"80"}),e(n,{prop:"order_no",label:"订单号",width:"200"}),e(n,{prop:"merchant_order_no",label:"商户订单号",width:"200"}),e(n,{prop:"notify_url",label:"回调地址","show-overflow-tooltip":""}),e(n,{prop:"status",label:"状态",width:"100"},{default:a(({row:o})=>[e(F,{type:ie(o.status)},{default:a(()=>[m(d(ue(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"retry_count",label:"重试次数",width:"100"}),e(n,{prop:"http_code",label:"HTTP状态码",width:"120"}),e(n,{prop:"response_data",label:"响应数据","show-overflow-tooltip":""}),e(n,{prop:"created_at",label:"创建时间",width:"180"})]),_:1},8,["data"])),[[W,V.value]]),l("div",Yt,[e(me,{"current-page":_.currentPage,"onUpdate:currentPage":t[7]||(t[7]=o=>_.currentPage=o),"page-size":_.pageSize,"onUpdate:pageSize":t[8]||(t[8]=o=>_.pageSize=o),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:oe},null,8,["current-page","page-size","total"])])]),_:1})])}}},It=pe(Dt,[["__scopeId","data-v-42b389f6"]]);export{It as default};
//# sourceMappingURL=callback-DzMB2SIo.js.map
