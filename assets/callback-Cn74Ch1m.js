import{s as P,g as pe,h as p,ac as J,y as ve,aK as fe,c as X,e as a,C as G,a as e,w as l,Y as r,as as he,M as z,x as f,aL as ge,m as ye,E as be,a5 as we,o as k,ap as ke,ar as Me,u,a7 as W,b as Ce,aM as Se,H as Y,ag as xe,j as Ee,v as m,a3 as Ve,aN as Te,aO as ze,A as Ye,K as Pe,k as U,aP as Qe,X as De,i as Be,D as Ne,l as He,aH as Le,J as Ue,aQ as Re,B as Ie,aR as qe,aS as Fe}from"./index-DQjW5cRd.js";/* empty css                *//* empty css                   *//* empty css            *//* empty css               *//* empty css              *//* empty css             *//* empty css                          */import"./form-item-l0sNRNKZ.js";/* empty css                     *//* empty css                 *//* empty css             */const $e=(y={})=>P({url:"/api/v1/admin/merchant-callback-monitor/merchant-stats",method:"get",params:y}),Oe=y=>P({url:"/api/v1/admin/merchant-callback-monitor/notify-logs",method:"get",params:y}),Ae=y=>P({url:"/api/v1/admin/merchant-callback-monitor/reset-circuit-breaker",method:"post",data:y}),je=()=>P({url:"/api/v1/admin/merchant-callback-monitor/queue-status",method:"get"}),Ke={class:"merchant-callback-monitor"},Je={class:"floating-time-selector"},Xe={class:"time-range-display"},Ge={class:"system-status-cards"},We={class:"card-header"},Ze={class:"queue-status"},et={class:"queue-overview"},tt={class:"overview-item"},at={class:"overview-icon notify"},lt={class:"overview-content"},st={class:"overview-count"},ot={class:"overview-limit"},nt={class:"overview-item"},rt={class:"overview-icon retry"},it={class:"overview-content"},ct={class:"overview-count"},ut={class:"overview-limit"},dt={class:"overview-item"},_t={class:"overview-icon failed"},mt={class:"overview-content"},pt={class:"overview-count"},vt={class:"overview-limit"},ft={class:"card-header"},ht={class:"merchant-overview"},gt={class:"merchant-stat-card"},yt={class:"stat-icon total"},bt={class:"stat-content"},wt={class:"merchant-stat-card"},kt={class:"stat-icon normal"},Mt={class:"stat-content"},Ct={class:"merchant-stat-card"},St={class:"stat-icon slow"},xt={class:"stat-content"},Et={class:"merchant-stat-card"},Vt={class:"stat-icon circuit"},Tt={class:"stat-content"},zt={class:"merchant-details"},Yt={class:"callback-url-container"},Pt=["onClick","title"],Qt={class:"card-header"},Dt={class:"header-actions"},Bt={key:0,class:"filters"},Nt={class:"pagination"},Ht={__name:"callback",setup(y){const h=p([]),R=p([]),g=p({notifyQueue:0,retryQueue:0,failedQueue:0,maxNotifyQueue:1e3,maxRetryQueue:500,maxFailedQueue:100});p({todayProcessed:0,processing:0,avgProcessTime:0,maxProcessTime:0});const M=p({totalMerchants:0,normalMerchants:0,slowMerchants:0,circuitBreakerMerchants:0}),C=p("1m"),x=p(!1),E=p(!1),Q=p(!1),D=p(!1),d=J({order_no:"",status:"",merchant_key:"",start_time:"",end_time:""}),_=J({currentPage:1,pageSize:20,total:0});let B=null;const Z=()=>{V(),b(),T()},ee=()=>({"5s":"最近5秒","1m":"最近1分钟","5m":"最近5分钟","10m":"最近10分钟","1h":"最近1小时","1d":"最近1天"})[C.value]||"最近1分钟",V=async()=>{x.value=!0;try{const s={time_range:C.value},t=await $e(s);t.code===200&&(h.value=t.data.merchants||[],te())}catch(s){f.error("获取商户统计失败"),console.error("获取商户统计失败:",s)}finally{x.value=!1}},te=()=>{Array.isArray(h.value)||(console.warn("merchantStats.value 不是数组:",h.value),h.value=[]);const s={totalMerchants:h.value.length,normalMerchants:0,slowMerchants:0,circuitBreakerMerchants:0};h.value.forEach(t=>{switch(t.status){case"normal":s.normalMerchants++;break;case"slow":s.slowMerchants++;break;case"circuit_breaker":s.circuitBreakerMerchants++;break}}),M.value=s},T=async()=>{Q.value=!0;try{const s=await je();s.code===200&&(g.value=s.data)}catch(s){f.error("获取队列状态失败"),console.error("获取队列状态失败:",s)}finally{Q.value=!1}},b=async()=>{E.value=!0;try{const s={page:_.currentPage,limit:_.pageSize,time_range:C.value,...d},t=await Oe(s);t.code===200&&(R.value=t.data.list,_.total=t.data.total)}catch(s){f.error("获取通知日志失败"),console.error("获取通知日志失败:",s)}finally{E.value=!1}},I=()=>{_.currentPage=1,b()},ae=()=>{Object.assign(d,{order_no:"",status:"",merchant_key:"",start_time:"",end_time:""}),I()},le=async s=>{try{await Fe.confirm("确定要重置该商户的熔断器吗？","确认重置",{type:"warning"});const t=await Ae({merchant_key:s});t.code===200?(f.success("熔断器重置成功"),V()):f.error(t.message||"重置失败")}catch(t){t!=="cancel"&&(f.error("重置熔断器失败"),console.error("重置熔断器失败:",t))}},se=s=>{_.pageSize=s,_.currentPage=1,b()},oe=s=>{_.currentPage=s,b()},ne=s=>({normal:"success",slow:"warning",circuit_breaker:"danger"})[s]||"info",re=s=>({normal:"正常",slow:"慢响应",circuit_breaker:"熔断"})[s]||"未知",ie=s=>({success:"success",failed:"danger",pending:"warning"})[s]||"info",ce=s=>({success:"成功",failed:"失败",pending:"处理中"})[s]||"未知",ue=s=>{console.log("查看商户详情:",s)},q=async s=>{if(s)try{await navigator.clipboard.writeText(s),f.success("回调地址已复制到剪贴板")}catch{const i=document.createElement("textarea");i.value=s,document.body.appendChild(i),i.select();try{document.execCommand("copy"),f.success("回调地址已复制到剪贴板")}catch{f.error("复制失败，请手动复制")}document.body.removeChild(i)}};return ve(()=>{V(),b(),T(),B=setInterval(()=>{T()},3e4)}),fe(()=>{B&&clearInterval(B)}),(s,t)=>{const i=Me,N=ke,de=ge,c=ye,v=Ee,H=we,S=Ce,F=be,n=Pe,$=De,O=Ye,A=He,w=Ne,j=Le,_e=Be,me=Ie,K=he;return k(),X("div",Ke,[t[27]||(t[27]=a("div",{class:"page-header"},[a("h1",null,"商户回调监控"),a("p",null,"实时监控商户回调状态和系统健康度")],-1)),a("div",Je,[e(de,{content:"选择监控时间范围",placement:"left"},{default:l(()=>[e(N,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=o=>C.value=o),onChange:Z,placeholder:"时间范围",size:"small",class:"time-range-select"},{default:l(()=>[e(i,{label:"最近5秒",value:"5s"}),e(i,{label:"最近1分钟",value:"1m"}),e(i,{label:"最近5分钟",value:"5m"}),e(i,{label:"最近10分钟",value:"10m"}),e(i,{label:"最近1小时",value:"1h"}),e(i,{label:"最近1天",value:"1d"})]),_:1},8,["modelValue"])]),_:1}),a("div",Xe,[e(c,null,{default:l(()=>[e(u(W))]),_:1}),a("span",null,r(ee()),1)])]),a("div",Ge,[e(F,{gutter:20},{default:l(()=>[e(S,{span:24},{default:l(()=>[e(H,{class:"status-card"},{header:l(()=>[a("div",We,[t[10]||(t[10]=a("span",null,"队列状态",-1)),e(v,{onClick:T,loading:Q.value,size:"small"},{default:l(()=>[e(c,null,{default:l(()=>[e(u(Y))]),_:1}),t[9]||(t[9]=m(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:l(()=>[a("div",Ze,[a("div",et,[a("div",tt,[a("div",at,[e(c,null,{default:l(()=>[e(u(Se))]),_:1})]),a("div",lt,[t[11]||(t[11]=a("div",{class:"overview-title"},"通知队列",-1)),a("div",st,r(g.value.notifyQueue||0),1),a("div",ot,"/ "+r(g.value.maxNotifyQueue||1e3),1)])]),a("div",nt,[a("div",rt,[e(c,null,{default:l(()=>[e(u(Y))]),_:1})]),a("div",it,[t[12]||(t[12]=a("div",{class:"overview-title"},"重试队列",-1)),a("div",ct,r(g.value.retryQueue||0),1),a("div",ut,"/ "+r(g.value.maxRetryQueue||500),1)])]),a("div",dt,[a("div",_t,[e(c,null,{default:l(()=>[e(u(xe))]),_:1})]),a("div",mt,[t[13]||(t[13]=a("div",{class:"overview-title"},"失败队列",-1)),a("div",pt,r(g.value.failedQueue||0),1),a("div",vt,"/ "+r(g.value.maxFailedQueue||100),1)])])])])]),_:1})]),_:1})]),_:1})]),G((k(),z(H,{class:"merchant-stats-card"},{header:l(()=>[a("div",ft,[t[15]||(t[15]=a("span",null,"商户状态统计",-1)),e(v,{onClick:V,loading:x.value},{default:l(()=>[e(c,null,{default:l(()=>[e(u(Y))]),_:1}),t[14]||(t[14]=m(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:l(()=>[a("div",ht,[e(F,{gutter:20},{default:l(()=>[e(S,{span:6},{default:l(()=>[a("div",gt,[a("div",yt,[e(c,null,{default:l(()=>[e(u(Ve))]),_:1})]),a("div",bt,[a("h3",null,r(M.value.totalMerchants||0),1),t[16]||(t[16]=a("p",null,"总商户数",-1))])])]),_:1}),e(S,{span:6},{default:l(()=>[a("div",wt,[a("div",kt,[e(c,null,{default:l(()=>[e(u(Te))]),_:1})]),a("div",Mt,[a("h3",null,r(M.value.normalMerchants||0),1),t[17]||(t[17]=a("p",null,"正常商户",-1))])])]),_:1}),e(S,{span:6},{default:l(()=>[a("div",Ct,[a("div",St,[e(c,null,{default:l(()=>[e(u(W))]),_:1})]),a("div",xt,[a("h3",null,r(M.value.slowMerchants||0),1),t[18]||(t[18]=a("p",null,"慢响应商户",-1))])])]),_:1}),e(S,{span:6},{default:l(()=>[a("div",Et,[a("div",Vt,[e(c,null,{default:l(()=>[e(u(ze))]),_:1})]),a("div",Tt,[a("h3",null,r(M.value.circuitBreakerMerchants||0),1),t[19]||(t[19]=a("p",null,"熔断商户",-1))])])]),_:1})]),_:1})]),a("div",zt,[e(O,{data:h.value,stripe:""},{default:l(()=>[e(n,{prop:"merchant_name",label:"商户名称","min-width":"150"},{default:l(({row:o})=>[m(r(o.merchant_name||o.merchant_key),1)]),_:1}),e(n,{prop:"merchant_key",label:"商户标识","min-width":"120"}),e(n,{prop:"notify_url",label:"回调地址","min-width":"200","show-overflow-tooltip":""},{default:l(({row:o})=>[a("div",Yt,[a("span",{class:"callback-url",onClick:L=>q(o.notify_url),title:o.notify_url},r(o.notify_url||"-"),9,Pt),o.notify_url?(k(),z(v,{key:0,onClick:L=>q(o.notify_url),type:"text",size:"small",class:"copy-btn",title:"复制回调地址"},{default:l(()=>[e(c,null,{default:l(()=>[e(u(Qe))]),_:1})]),_:1},8,["onClick"])):U("",!0)])]),_:1}),e(n,{prop:"status",label:"状态",width:"100"},{default:l(({row:o})=>[e($,{type:ne(o.status)},{default:l(()=>[m(r(re(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"failed_requests",label:"失败数",width:"80"}),e(n,{prop:"avg_response_time",label:"平均响应时间",width:"120"},{default:l(({row:o})=>[m(r(o.avg_response_time||0)+"ms ",1)]),_:1}),e(n,{label:"操作",width:"120"},{default:l(({row:o})=>[o.status==="circuit_breaker"?(k(),z(v,{key:0,onClick:L=>le(o.merchant_key),type:"warning",size:"small"},{default:l(()=>[...t[20]||(t[20]=[m(" 重置熔断器 ",-1)])]),_:1},8,["onClick"])):U("",!0),e(v,{onClick:L=>ue(o),type:"primary",size:"small"},{default:l(()=>[...t[21]||(t[21]=[m(" 查看详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1})),[[K,x.value]]),e(H,{class:"notify-logs-card"},{header:l(()=>[a("div",Qt,[t[24]||(t[24]=a("span",null,"通知日志",-1)),a("div",Dt,[e(v,{onClick:b,loading:E.value},{default:l(()=>[e(c,null,{default:l(()=>[e(u(Y))]),_:1}),t[22]||(t[22]=m(" 刷新 ",-1))]),_:1},8,["loading"]),e(v,{onClick:t[1]||(t[1]=o=>D.value=!D.value)},{default:l(()=>[e(c,null,{default:l(()=>[e(u(qe))]),_:1}),t[23]||(t[23]=m(" 筛选 ",-1))]),_:1})])])]),default:l(()=>[D.value?(k(),X("div",Bt,[e(_e,{model:d,inline:""},{default:l(()=>[e(w,{label:"订单号"},{default:l(()=>[e(A,{modelValue:d.order_no,"onUpdate:modelValue":t[2]||(t[2]=o=>d.order_no=o),placeholder:"请输入订单号",clearable:""},null,8,["modelValue"])]),_:1}),e(w,{label:"状态"},{default:l(()=>[e(N,{modelValue:d.status,"onUpdate:modelValue":t[3]||(t[3]=o=>d.status=o),placeholder:"请选择状态",clearable:""},{default:l(()=>[e(i,{label:"全部",value:""}),e(i,{label:"成功",value:"success"}),e(i,{label:"失败",value:"failed"}),e(i,{label:"处理中",value:"pending"})]),_:1},8,["modelValue"])]),_:1}),e(w,{label:"商户标识"},{default:l(()=>[e(A,{modelValue:d.merchant_key,"onUpdate:modelValue":t[4]||(t[4]=o=>d.merchant_key=o),placeholder:"请输入商户标识",clearable:""},null,8,["modelValue"])]),_:1}),e(w,{label:"开始时间"},{default:l(()=>[e(j,{modelValue:d.start_time,"onUpdate:modelValue":t[5]||(t[5]=o=>d.start_time=o),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),e(w,{label:"结束时间"},{default:l(()=>[e(j,{modelValue:d.end_time,"onUpdate:modelValue":t[6]||(t[6]=o=>d.end_time=o),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),e(w,null,{default:l(()=>[e(v,{type:"primary",onClick:I},{default:l(()=>[e(c,null,{default:l(()=>[e(u(Ue))]),_:1}),t[25]||(t[25]=m(" 搜索 ",-1))]),_:1}),e(v,{onClick:ae},{default:l(()=>[e(c,null,{default:l(()=>[e(u(Re))]),_:1}),t[26]||(t[26]=m(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])])):U("",!0),G((k(),z(O,{data:R.value,stripe:""},{default:l(()=>[e(n,{prop:"id",label:"ID",width:"80"}),e(n,{prop:"order_no",label:"订单号",width:"200"}),e(n,{prop:"merchant_order_no",label:"商户订单号",width:"200"}),e(n,{prop:"notify_url",label:"回调地址","show-overflow-tooltip":""}),e(n,{prop:"status",label:"状态",width:"100"},{default:l(({row:o})=>[e($,{type:ie(o.status)},{default:l(()=>[m(r(ce(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"retry_count",label:"重试次数",width:"100"}),e(n,{prop:"http_code",label:"HTTP状态码",width:"120"}),e(n,{prop:"response_data",label:"响应数据","show-overflow-tooltip":""}),e(n,{prop:"created_at",label:"创建时间",width:"180"})]),_:1},8,["data"])),[[K,E.value]]),a("div",Nt,[e(me,{"current-page":_.currentPage,"onUpdate:currentPage":t[7]||(t[7]=o=>_.currentPage=o),"page-size":_.pageSize,"onUpdate:pageSize":t[8]||(t[8]=o=>_.pageSize=o),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:oe},null,8,["current-page","page-size","total"])])]),_:1})])}}},Xt=pe(Ht,[["__scopeId","data-v-a88c4662"]]);export{Xt as default};
//# sourceMappingURL=callback-Cn74Ch1m.js.map
