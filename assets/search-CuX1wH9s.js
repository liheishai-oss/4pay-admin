import{d as pe,g as p,h as me,c as d,o as r,a as s,i as N,j as _,w as a,x as ve,y as fe,z as ge,H as ye,q as he,n as g,k as be,u as x,V as we,S as ke,a1 as Ce,M as K,as as W,e as t,t as n,a8 as Te,ba as Ee,bb as Se,P as Ve,aW as xe,bc as ze,bd as De,be as Ie,bf as Ne,C as $e,E as qe,b as Fe,O as Be,W as Me,ac as Oe,D as v,s as $,_ as Ue}from"./index-Dwi2X-zo.js";/* empty css                     *//* empty css                 *//* empty css              *//* empty css                   *//* empty css               */const je={class:"trace-search"},Le={class:"card-header"},Pe={class:"trace-header"},Re={class:"trace-info"},Ke={class:"trace-id"},We={class:"trace-meta"},He={key:0,class:"order-no"},Je={key:1,class:"merchant-order-no"},Ae={class:"step-count"},Ge={class:"created-time"},Qe={class:"trace-actions"},Xe={key:0,class:"pagination-wrapper"},Ye={key:0,class:"trace-detail"},Ze={class:"overview-content"},et={class:"overview-item"},tt={class:"value"},st={key:0,class:"overview-item"},at={class:"value order-no-value"},lt={key:1,class:"overview-item"},ot={class:"value merchant-order-no-value"},nt={class:"overview-item"},rt={class:"value"},it={class:"overview-item"},ct={class:"value"},dt={class:"overview-item"},ut={class:"value success"},_t={class:"overview-item"},pt={class:"value error"},mt={class:"overview-item"},vt={class:"value"},ft={class:"step-content"},gt={class:"step-header"},yt={class:"step-name"},ht={key:0,class:"step-duration"},bt={key:0,class:"step-data"},wt={class:"step-data-content"},kt={key:0,class:"trace-statistics"},Ct={class:"stat-item"},Tt={class:"stat-value"},Et={class:"stat-item"},St={class:"stat-value success"},Vt={class:"stat-item"},xt={class:"stat-value error"},zt={class:"stat-item"},Dt={class:"stat-value"},It={class:"stat-item"},Nt={class:"stat-value"},$t=pe({__name:"search",setup(qt){const f=p({keyword:""}),z=p(!1),D=p(!1),y=p([]),i=me({page:1,limit:20,total:0}),C=p(!1),h=p(null),c=p(null),I=p(!1),m=p(null),T=async()=>{if(!f.value.keyword.trim()){v.warning("请输入搜索关键词");return}z.value=!0;try{const l=await $.get("/api/v1/admin/trace/search",{params:{keyword:f.value.keyword,page:i.page,limit:i.limit}});l.code===200?(y.value=l.data.traces,i.total=l.data.total,D.value=!0):v.error(l.message||"搜索失败")}catch(l){console.error("搜索失败:",l),v.error("搜索失败，请重试")}finally{z.value=!1}},H=()=>{f.value.keyword="",y.value=[],D.value=!1,i.page=1,i.total=0},J=l=>{i.limit=l,i.page=1,T()},A=l=>{i.page=l,T()},G=async l=>{h.value=l,C.value=!0;try{const e=l.trace_type==="query"?"query":"lifecycle",b=await $.get(`/api/v1/admin/trace/${e}/${l.trace_id}`);b.code===200?c.value=b.data:v.error(b.message||"获取详情失败")}catch(e){console.error("获取详情失败:",e),v.error("获取详情失败，请重试")}},Q=async l=>{h.value=l,I.value=!0;try{const e=await $.get(`/api/v1/admin/trace/statistics/${l.trace_id}`,{params:{type:l.trace_type}});e.code===200?m.value=e.data:v.error(e.message||"获取统计失败")}catch(e){console.error("获取统计失败:",e),v.error("获取统计失败，请重试")}},X=()=>{C.value=!1,h.value=null,c.value=null},Y=l=>l==="lifecycle"?"primary":"success",Z=l=>l==="lifecycle"?"生命周期":"查询链路",ee=l=>{switch(l){case"success":return"success";case"failed":return"danger";case"pending":return"warning";default:return"info"}},te=l=>{switch(l){case"success":return"success";case"failed":return"danger";case"pending":return"warning";default:return"info"}},se=l=>{switch(l){case"success":return"成功";case"failed":return"失败";case"pending":return"待处理";default:return"未知"}},ae=l=>({order_created:"订单创建",param_validated:"参数验证",merchant_validated:"商户验证",product_validated:"产品验证",channel_selected:"通道选择",payment_initiated:"支付发起",payment_success:"支付成功",payment_failed:"支付失败",callback_sent:"回调发送",callback_success:"回调成功",callback_failed:"回调失败",order_completed:"订单完成",order_closed:"订单关闭",order_timeout:"订单超时",query_request:"查询请求",order_found:"订单找到",order_not_found:"订单未找到",response_formatted:"响应格式化",query_completed:"查询完成",manual_callback_triggered:"人工补发回调",auto_callback_triggered:"自动补发回调"})[l]||l,q=l=>new Date(l).toLocaleString(),F=()=>{var l;if(!((l=c.value)!=null&&l.steps))return null;for(const e of c.value.steps)if(e.order_no)return e.order_no;return null},B=()=>{var l;if(!((l=c.value)!=null&&l.steps))return null;for(const e of c.value.steps)if(e.merchant_order_no)return e.merchant_order_no;return null};return(l,e)=>{var L,P;const b=ge,M=fe,E=be,S=he,le=ve,u=Ce,O=Te,oe=Ve,ne=xe,re=Ne,ie=Ie,ce=De,de=ze,U=$e,w=Fe,j=qe,k=Me,ue=Be;return r(),d("div",je,[s(u,{class:"search-card"},{default:a(()=>[s(le,{model:f.value,inline:"",class:"search-form"},{default:a(()=>[s(M,{label:"搜索关键词"},{default:a(()=>[s(b,{modelValue:f.value.keyword,"onUpdate:modelValue":e[0]||(e[0]=o=>f.value.keyword=o),placeholder:"输入平台订单号、商户订单号或Trace ID",onKeyup:ye(T,["enter"]),clearable:"",style:{width:"400px"}},null,8,["modelValue"])]),_:1}),s(M,null,{default:a(()=>[s(S,{type:"primary",onClick:T,loading:z.value},{default:a(()=>[s(E,null,{default:a(()=>[s(x(we))]),_:1}),e[5]||(e[5]=g(" 搜索 ",-1))]),_:1},8,["loading"]),s(S,{onClick:H},{default:a(()=>[s(E,null,{default:a(()=>[s(x(ke))]),_:1}),e[6]||(e[6]=g(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),y.value.length>0?(r(),N(u,{key:0,class:"results-card"},{header:a(()=>[t("div",Le,[t("span",null,"搜索结果 ("+n(y.value.length)+" 条)",1)])]),default:a(()=>[(r(!0),d(K,null,W(y.value,o=>{var V,R;return r(),d("div",{key:o.trace_id,class:"trace-item"},[t("div",Pe,[t("div",Re,[t("span",Ke,n(o.trace_id),1),s(O,{type:Y(o.trace_type),size:"small"},{default:a(()=>[g(n(Z(o.trace_type)),1)]),_:2},1032,["type"])]),t("div",We,[(V=o.latest_step)!=null&&V.order_no?(r(),d("span",He,"平台订单号: "+n(o.latest_step.order_no),1)):_("",!0),(R=o.latest_step)!=null&&R.merchant_order_no?(r(),d("span",Je,"商户订单号: "+n(o.latest_step.merchant_order_no),1)):_("",!0),t("span",Ae,"步骤数: "+n(o.step_count),1),t("span",Ge,n(q(o.created_at)),1)])]),t("div",Qe,[s(S,{size:"small",onClick:_e=>G(o)},{default:a(()=>[s(E,null,{default:a(()=>[s(x(Ee))]),_:1}),e[7]||(e[7]=g(" 查看详情 ",-1))]),_:1},8,["onClick"]),s(S,{size:"small",onClick:_e=>Q(o)},{default:a(()=>[s(E,null,{default:a(()=>[s(x(Se))]),_:1}),e[8]||(e[8]=g(" 统计分析 ",-1))]),_:1},8,["onClick"])])])}),128)),i.total>0?(r(),d("div",Xe,[s(oe,{"current-page":i.page,"onUpdate:currentPage":e[1]||(e[1]=o=>i.page=o),"page-size":i.limit,"onUpdate:pageSize":e[2]||(e[2]=o=>i.limit=o),"page-sizes":[10,20,50,100],total:i.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:A},null,8,["current-page","page-size","total"])])):_("",!0)]),_:1})):D.value?(r(),N(u,{key:1,class:"empty-card"},{default:a(()=>[s(ne,{description:"未找到相关链路数据"})]),_:1})):_("",!0),s(U,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=o=>C.value=o),title:`链路详情 - ${(L=h.value)==null?void 0:L.trace_id}`,width:"80%","before-close":X},{default:a(()=>[c.value?(r(),d("div",Ye,[s(u,{class:"trace-overview"},{header:a(()=>[...e[9]||(e[9]=[t("span",null,"链路概览",-1)])]),default:a(()=>[t("div",Ze,[t("div",et,[e[10]||(e[10]=t("span",{class:"label"},"追踪ID:",-1)),t("span",tt,n(c.value.trace_id),1)]),F()?(r(),d("div",st,[e[11]||(e[11]=t("span",{class:"label"},"平台订单号:",-1)),t("span",at,n(F()),1)])):_("",!0),B()?(r(),d("div",lt,[e[12]||(e[12]=t("span",{class:"label"},"商户订单号:",-1)),t("span",ot,n(B()),1)])):_("",!0),t("div",nt,[e[13]||(e[13]=t("span",{class:"label"},"商户ID:",-1)),t("span",rt,n(c.value.merchant_id),1)]),t("div",it,[e[14]||(e[14]=t("span",{class:"label"},"总步骤数:",-1)),t("span",ct,n(c.value.total_steps),1)]),t("div",dt,[e[15]||(e[15]=t("span",{class:"label"},"成功步骤:",-1)),t("span",ut,n(c.value.success_steps),1)]),t("div",_t,[e[16]||(e[16]=t("span",{class:"label"},"失败步骤:",-1)),t("span",pt,n(c.value.failed_steps),1)]),t("div",mt,[e[17]||(e[17]=t("span",{class:"label"},"总耗时:",-1)),t("span",vt,n(c.value.total_duration)+"ms",1)])])]),_:1}),s(u,{class:"trace-timeline"},{header:a(()=>[...e[18]||(e[18]=[t("span",null,"步骤时间线",-1)])]),default:a(()=>[s(de,null,{default:a(()=>[(r(!0),d(K,null,W(c.value.steps,(o,V)=>(r(),N(ce,{key:V,type:ee(o.step_status),timestamp:q(o.created_at)},{default:a(()=>[t("div",ft,[t("div",gt,[t("span",yt,n(ae(o.step_name)),1),s(O,{type:te(o.step_status),size:"small"},{default:a(()=>[g(n(se(o.step_status)),1)]),_:2},1032,["type"]),o.duration_ms>0?(r(),d("span",ht," 耗时: "+n(o.duration_ms)+"ms ",1)):_("",!0)]),o.step_data&&Object.keys(o.step_data).length>0?(r(),d("div",bt,[s(ie,null,{default:a(()=>[s(re,{title:"步骤数据"},{default:a(()=>[t("pre",wt,n(JSON.stringify(o.step_data,null,2)),1)]),_:2},1024)]),_:2},1024)])):_("",!0)])]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1})])):_("",!0)]),_:1},8,["modelValue","title"]),s(U,{modelValue:I.value,"onUpdate:modelValue":e[4]||(e[4]=o=>I.value=o),title:`统计分析 - ${(P=h.value)==null?void 0:P.trace_id}`,width:"60%"},{default:a(()=>[m.value?(r(),d("div",kt,[s(j,{gutter:20},{default:a(()=>[s(w,{span:8},{default:a(()=>[s(u,{class:"stat-card"},{default:a(()=>[t("div",Ct,[t("div",Tt,n(m.value.total_steps),1),e[19]||(e[19]=t("div",{class:"stat-label"},"总步骤数",-1))])]),_:1})]),_:1}),s(w,{span:8},{default:a(()=>[s(u,{class:"stat-card"},{default:a(()=>[t("div",Et,[t("div",St,n(m.value.success_steps),1),e[20]||(e[20]=t("div",{class:"stat-label"},"成功步骤",-1))])]),_:1})]),_:1}),s(w,{span:8},{default:a(()=>[s(u,{class:"stat-card"},{default:a(()=>[t("div",Vt,[t("div",xt,n(m.value.failed_steps),1),e[21]||(e[21]=t("div",{class:"stat-label"},"失败步骤",-1))])]),_:1})]),_:1})]),_:1}),s(j,{gutter:20,style:{"margin-top":"20px"}},{default:a(()=>[s(w,{span:12},{default:a(()=>[s(u,{class:"stat-card"},{default:a(()=>[t("div",zt,[t("div",Dt,n(m.value.success_rate)+"%",1),e[22]||(e[22]=t("div",{class:"stat-label"},"成功率",-1))])]),_:1})]),_:1}),s(w,{span:12},{default:a(()=>[s(u,{class:"stat-card"},{default:a(()=>[t("div",It,[t("div",Nt,n(m.value.total_duration)+"ms",1),e[23]||(e[23]=t("div",{class:"stat-label"},"总耗时",-1))])]),_:1})]),_:1})]),_:1}),s(u,{style:{"margin-top":"20px"}},{header:a(()=>[...e[24]||(e[24]=[t("span",null,"步骤分解统计",-1)])]),default:a(()=>[s(ue,{data:m.value.step_breakdown,border:""},{default:a(()=>[s(k,{prop:"step_name",label:"步骤名称"}),s(k,{prop:"count",label:"执行次数"}),s(k,{prop:"success_count",label:"成功次数"}),s(k,{prop:"failed_count",label:"失败次数"}),s(k,{prop:"success_rate",label:"成功率"},{default:a(({row:o})=>[t("span",{class:Oe(o.success_rate>=80?"success":"error")},n(o.success_rate)+"% ",3)]),_:1})]),_:1},8,["data"])]),_:1})])):_("",!0)]),_:1},8,["modelValue","title"])])}}}),Lt=Ue($t,[["__scopeId","data-v-3b5d7c14"]]);export{Lt as default};
//# sourceMappingURL=search-CuX1wH9s.js.map
