{"version":3,"file":"product-management-BpdOh7Z-.js","sources":["../../src/pages/merchant/product-management.vue"],"sourcesContent":["<template>\n  <el-dialog\n    v-model=\"visible\"\n    title=\"产品管理\"\n    width=\"800px\"\n    :close-on-click-modal=\"false\"\n    @close=\"handleClose\"\n  >\n    <!-- 产品信息 -->\n    <div v-if=\"merchantInfo\" class=\"merchant-info\">\n      <el-card shadow=\"never\" class=\"info-card\">\n        <div class=\"info-row\">\n          <span class=\"label\">商户名称：</span>\n          <span class=\"value\">{{ merchantInfo.merchant_name }}</span>\n        </div>\n      </el-card>\n    </div>\n\n    <!-- 产品列表 -->\n    <div class=\"product-list\">\n      <el-table\n        :data=\"productList\"\n        border\n        stripe\n        max-height=\"500\"\n        v-loading=\"loading\"\n        empty-text=\"暂无分配的产品\"\n      >\n        <el-table-column prop=\"product_name\" label=\"产品名称\" align=\"center\" min-width=\"200\"/>\n        <el-table-column label=\"状态\" align=\"center\" min-width=\"100\">\n          <template #default=\"{ row }\">\n            <el-switch\n              v-model=\"row.is_assigned\"\n              :active-value=\"true\"\n              :inactive-value=\"false\"\n              @change=\"handleStatusChange(row)\"\n            />\n          </template>\n        </el-table-column>\n        <el-table-column label=\"商户费率\" align=\"center\" min-width=\"150\">\n          <template #default=\"{ row }\">\n            <div class=\"rate-edit\">\n              <el-input-number\n                v-model=\"row.merchant_rate_percent\"\n                :min=\"0\"\n                :max=\"100\"\n                :precision=\"2\"\n                :step=\"0.01\"\n                size=\"small\"\n                @change=\"handleRateChange(row)\"\n              />\n              <span class=\"rate-unit\">%</span>\n            </div>\n          </template>\n        </el-table-column>\n      </el-table>\n    </div>\n\n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"handleClose\">关闭</el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script lang=\"ts\" setup>\nimport { ref, watch } from 'vue';\nimport { ElMessage } from 'element-plus';\nimport { getMerchantProducts } from '@/api/merchant';\nimport { assignProductToMerchant, updateMerchantRate } from '@/api/product';\n\n// 接口定义\ninterface MerchantInfo {\n  id: number;\n  merchant_name: string;\n}\n\ninterface ProductInfo {\n  id: number;\n  product_name: string;\n  external_code: string;\n  merchant_rate: number;\n  merchant_rate_percent: number;\n  is_assigned: boolean;\n  assigned_at?: string;\n}\n\n// 响应式数据\nconst visible = ref(false);\nconst loading = ref(false);\nconst merchantInfo = ref<MerchantInfo | null>(null);\nconst productList = ref<ProductInfo[]>([]);\n\n// 打开对话框\nconst open = (merchant: MerchantInfo) => {\n  merchantInfo.value = merchant;\n  visible.value = true;\n  loadProductList();\n};\n\n// 加载产品列表\nconst loadProductList = async () => {\n  if (!merchantInfo.value?.id) return;\n  \n  try {\n    loading.value = true;\n    console.log('查询商户产品，商户ID:', merchantInfo.value.id);\n    const res = await getMerchantProducts(merchantInfo.value.id);\n    \n    if (res.code === 200) {\n      // 转换BP为百分比显示\n      productList.value = res.data.products.map((product: any) => ({\n        ...product,\n        merchant_rate_percent: (product.merchant_rate / 100).toFixed(2)\n      }));\n    } else {\n      ElMessage.error(res.message || '获取产品列表失败');\n      productList.value = [];\n    }\n  } catch (error) {\n    console.error('获取产品列表失败:', error);\n    ElMessage.error('获取产品列表失败');\n    productList.value = [];\n  } finally {\n    loading.value = false;\n  }\n};\n\n// 关闭对话框\nconst handleClose = () => {\n  visible.value = false;\n  merchantInfo.value = null;\n  productList.value = [];\n};\n\n// 处理状态变化\nconst handleStatusChange = async (row: ProductInfo) => {\n  if (!merchantInfo.value?.id) return;\n  \n  try {\n    const res = await assignProductToMerchant({\n      product_id: row.id,\n      merchant_id: merchantInfo.value.id,\n      merchant_rate: Math.round(row.merchant_rate_percent * 100), // 转换为存储格式\n      status: row.is_assigned ? 1 : 0\n    });\n    \n    if (res.code === 200) {\n      ElMessage.success(row.is_assigned ? '分配成功' : '取消分配成功');\n    } else {\n      // 回滚状态\n      row.is_assigned = !row.is_assigned;\n      ElMessage.error(res.message || '操作失败');\n    }\n  } catch (error) {\n    // 回滚状态\n    row.is_assigned = !row.is_assigned;\n    console.error('状态变更失败:', error);\n    ElMessage.error('操作失败');\n  }\n};\n\n// 处理费率变化\nconst handleRateChange = async (row: ProductInfo) => {\n  if (!merchantInfo.value?.id || !row.is_assigned) return;\n  \n  try {\n    const res = await updateMerchantRate({\n      product_id: row.id,\n      merchant_id: merchantInfo.value.id,\n      merchant_rate: Math.round(row.merchant_rate_percent * 100) // 转换为存储格式\n    });\n    \n    if (res.code === 200) {\n      ElMessage.success('费率更新成功');\n    } else {\n      ElMessage.error(res.message || '费率更新失败');\n    }\n  } catch (error) {\n    console.error('费率更新失败:', error);\n    ElMessage.error('费率更新失败');\n  }\n};\n\n// 监听对话框显示状态\nwatch(visible, (newVal) => {\n  if (!newVal) {\n    handleClose();\n  }\n});\n\n// 暴露方法\ndefineExpose({\n  open\n});\n</script>\n\n<style scoped>\n.merchant-info {\n  margin-bottom: 20px;\n}\n\n.info-card {\n  background-color: #f8f9fa;\n}\n\n.info-row {\n  display: flex;\n  align-items: center;\n  margin-bottom: 8px;\n}\n\n.info-row:last-child {\n  margin-bottom: 0;\n}\n\n.label {\n  font-weight: 500;\n  color: #606266;\n  min-width: 80px;\n}\n\n.value {\n  color: #303133;\n  font-weight: 600;\n}\n\n.product-list {\n  margin-top: 20px;\n}\n\n.rate-text {\n  color: #67c23a;\n  font-weight: 600;\n}\n\n.dialog-footer {\n  text-align: right;\n}\n\n/* 费率编辑样式 */\n.rate-edit {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 4px;\n}\n\n.rate-unit {\n  color: #606266;\n  font-size: 12px;\n}\n</style>\n"],"names":["visible","ref","loading","merchantInfo","productList","open","merchant","loadProductList","_a","res","getMerchantProducts","product","ElMessage","error","handleClose","handleStatusChange","row","assignProductToMerchant","handleRateChange","updateMerchantRate","watch","newVal","__expose","_createBlock","_component_el_dialog","$event","_createElementVNode","_hoisted_6","_createVNode","_component_el_button","_cache","_openBlock","_createElementBlock","_hoisted_1","_component_el_card","_hoisted_2","_hoisted_3","_toDisplayString","_hoisted_4","_component_el_table","_component_el_table_column","_withCtx","_component_el_switch","_hoisted_5","_component_el_input_number"],"mappings":"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"}