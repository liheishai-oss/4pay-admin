import{s as Q,_ as pe,g as p,h as W,L as ve,aK as fe,c as G,e as l,Q as J,a as e,w as a,t as r,au as he,i as z,C as f,aL as ge,k as ye,E as be,a1 as we,o as k,ar as ke,at as Me,u,aM as X,b as Ce,aN as Se,S as P,ai as xe,q as Ee,n as m,a4 as Ve,aO as Te,p as ze,O as Pe,W as Qe,j as U,aP as Ye,a8 as De,x as Be,y as Ne,z as Le,aH as He,V as Ue,aQ as Re,P as qe,aR as Ie,aS as Fe}from"./index-DSzZq5R0.js";/* empty css                *//* empty css                   *//* empty css               *//* empty css                          *//* empty css                     *//* empty css                 */const Oe=(y={})=>Q({url:"/api/v1/admin/merchant-callback-monitor/merchant-stats",method:"get",params:y}),$e=y=>Q({url:"/api/v1/admin/merchant-callback-monitor/notify-logs",method:"get",params:y}),je=y=>Q({url:"/api/v1/admin/merchant-callback-monitor/reset-circuit-breaker",method:"post",data:y}),Ae=()=>Q({url:"/api/v1/admin/merchant-callback-monitor/queue-status",method:"get"}),Ke={class:"merchant-callback-monitor"},We={class:"floating-time-selector"},Ge={class:"time-range-display"},Je={class:"system-status-cards"},Xe={class:"card-header"},Ze={class:"queue-status"},et={class:"queue-overview"},tt={class:"overview-item"},at={class:"overview-icon notify"},lt={class:"overview-content"},st={class:"overview-count"},ot={class:"overview-limit"},nt={class:"overview-item"},rt={class:"overview-icon retry"},it={class:"overview-content"},ct={class:"overview-count"},ut={class:"overview-limit"},dt={class:"overview-item"},_t={class:"overview-icon failed"},mt={class:"overview-content"},pt={class:"overview-count"},vt={class:"overview-limit"},ft={class:"card-header"},ht={class:"merchant-overview"},gt={class:"merchant-stat-card"},yt={class:"stat-icon total"},bt={class:"stat-content"},wt={class:"merchant-stat-card"},kt={class:"stat-icon normal"},Mt={class:"stat-content"},Ct={class:"merchant-stat-card"},St={class:"stat-icon slow"},xt={class:"stat-content"},Et={class:"merchant-stat-card"},Vt={class:"stat-icon circuit"},Tt={class:"stat-content"},zt={class:"merchant-details"},Pt={class:"callback-url-container"},Qt=["onClick","title"],Yt={class:"card-header"},Dt={class:"header-actions"},Bt={key:0,class:"filters"},Nt={class:"pagination"},Lt={__name:"callback",setup(y){const h=p([]),R=p([]),g=p({notifyQueue:0,retryQueue:0,failedQueue:0,maxNotifyQueue:1e3,maxRetryQueue:500,maxFailedQueue:100});p({todayProcessed:0,processing:0,avgProcessTime:0,maxProcessTime:0});const M=p({totalMerchants:0,normalMerchants:0,slowMerchants:0,circuitBreakerMerchants:0}),C=p("1m"),x=p(!1),E=p(!1),Y=p(!1),D=p(!1),d=W({order_no:"",status:"",merchant_key:"",start_time:"",end_time:""}),_=W({currentPage:1,pageSize:20,total:0});let B=null;const Z=()=>{V(),b(),T()},ee=()=>({"5s":"最近5秒","1m":"最近1分钟","5m":"最近5分钟","10m":"最近10分钟","1h":"最近1小时","1d":"最近1天"})[C.value]||"最近1分钟",V=async()=>{x.value=!0;try{const s={time_range:C.value},t=await Oe(s);t.code===200&&(h.value=t.data.merchants||[],te())}catch(s){f.error("获取商户统计失败"),console.error("获取商户统计失败:",s)}finally{x.value=!1}},te=()=>{Array.isArray(h.value)||(console.warn("merchantStats.value 不是数组:",h.value),h.value=[]);const s={totalMerchants:h.value.length,normalMerchants:0,slowMerchants:0,circuitBreakerMerchants:0};h.value.forEach(t=>{switch(t.status){case"normal":s.normalMerchants++;break;case"slow":s.slowMerchants++;break;case"circuit_breaker":s.circuitBreakerMerchants++;break}}),M.value=s},T=async()=>{Y.value=!0;try{const s=await Ae();s.code===200&&(g.value=s.data)}catch(s){f.error("获取队列状态失败"),console.error("获取队列状态失败:",s)}finally{Y.value=!1}},b=async()=>{E.value=!0;try{const s={page:_.currentPage,limit:_.pageSize,time_range:C.value,...d},t=await $e(s);t.code===200&&(R.value=t.data.list,_.total=t.data.total)}catch(s){f.error("获取通知日志失败"),console.error("获取通知日志失败:",s)}finally{E.value=!1}},q=()=>{_.currentPage=1,b()},ae=()=>{Object.assign(d,{order_no:"",status:"",merchant_key:"",start_time:"",end_time:""}),q()},le=async s=>{try{await Fe.confirm("确定要重置该商户的熔断器吗？","确认重置",{type:"warning"});const t=await je({merchant_key:s});t.code===200?(f.success("熔断器重置成功"),V()):f.error(t.message||"重置失败")}catch(t){t!=="cancel"&&(f.error("重置熔断器失败"),console.error("重置熔断器失败:",t))}},se=s=>{_.pageSize=s,_.currentPage=1,b()},oe=s=>{_.currentPage=s,b()},ne=s=>({normal:"success",slow:"warning",circuit_breaker:"danger"})[s]||"info",re=s=>({normal:"正常",slow:"慢响应",circuit_breaker:"熔断"})[s]||"未知",ie=s=>({success:"success",failed:"danger",pending:"warning"})[s]||"info",ce=s=>({success:"成功",failed:"失败",pending:"处理中"})[s]||"未知",ue=s=>{console.log("查看商户详情:",s)},I=async s=>{if(s)try{await navigator.clipboard.writeText(s),f.success("回调地址已复制到剪贴板")}catch{const i=document.createElement("textarea");i.value=s,document.body.appendChild(i),i.select();try{document.execCommand("copy"),f.success("回调地址已复制到剪贴板")}catch{f.error("复制失败，请手动复制")}document.body.removeChild(i)}};return ve(()=>{V(),b(),T(),B=setInterval(()=>{T()},3e4)}),fe(()=>{B&&clearInterval(B)}),(s,t)=>{const i=Me,N=ke,de=ge,c=ye,v=Ee,L=we,S=Ce,F=be,n=Qe,O=De,$=Pe,j=Le,w=Ne,A=He,_e=Be,me=qe,K=he;return k(),G("div",Ke,[l("div",We,[e(de,{content:"选择监控时间范围",placement:"left"},{default:a(()=>[e(N,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=o=>C.value=o),onChange:Z,placeholder:"时间范围",size:"small",class:"time-range-select"},{default:a(()=>[e(i,{label:"最近5秒",value:"5s"}),e(i,{label:"最近1分钟",value:"1m"}),e(i,{label:"最近5分钟",value:"5m"}),e(i,{label:"最近10分钟",value:"10m"}),e(i,{label:"最近1小时",value:"1h"}),e(i,{label:"最近1天",value:"1d"})]),_:1},8,["modelValue"])]),_:1}),l("div",Ge,[e(c,null,{default:a(()=>[e(u(X))]),_:1}),l("span",null,r(ee()),1)])]),l("div",Je,[e(F,{gutter:20},{default:a(()=>[e(S,{span:24},{default:a(()=>[e(L,{class:"status-card"},{header:a(()=>[l("div",Xe,[t[10]||(t[10]=l("span",null,"队列状态",-1)),e(v,{onClick:T,loading:Y.value,size:"small"},{default:a(()=>[e(c,null,{default:a(()=>[e(u(P))]),_:1}),t[9]||(t[9]=m(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:a(()=>[l("div",Ze,[l("div",et,[l("div",tt,[l("div",at,[e(c,null,{default:a(()=>[e(u(Se))]),_:1})]),l("div",lt,[t[11]||(t[11]=l("div",{class:"overview-title"},"通知队列",-1)),l("div",st,r(g.value.notifyQueue||0),1),l("div",ot,"/ "+r(g.value.maxNotifyQueue||1e3),1)])]),l("div",nt,[l("div",rt,[e(c,null,{default:a(()=>[e(u(P))]),_:1})]),l("div",it,[t[12]||(t[12]=l("div",{class:"overview-title"},"重试队列",-1)),l("div",ct,r(g.value.retryQueue||0),1),l("div",ut,"/ "+r(g.value.maxRetryQueue||500),1)])]),l("div",dt,[l("div",_t,[e(c,null,{default:a(()=>[e(u(xe))]),_:1})]),l("div",mt,[t[13]||(t[13]=l("div",{class:"overview-title"},"失败队列",-1)),l("div",pt,r(g.value.failedQueue||0),1),l("div",vt,"/ "+r(g.value.maxFailedQueue||100),1)])])])])]),_:1})]),_:1})]),_:1})]),J((k(),z(L,{class:"merchant-stats-card"},{header:a(()=>[l("div",ft,[t[15]||(t[15]=l("span",null,"商户状态统计",-1)),e(v,{onClick:V,loading:x.value},{default:a(()=>[e(c,null,{default:a(()=>[e(u(P))]),_:1}),t[14]||(t[14]=m(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:a(()=>[l("div",ht,[e(F,{gutter:20},{default:a(()=>[e(S,{span:6},{default:a(()=>[l("div",gt,[l("div",yt,[e(c,null,{default:a(()=>[e(u(Ve))]),_:1})]),l("div",bt,[l("h3",null,r(M.value.totalMerchants||0),1),t[16]||(t[16]=l("p",null,"总商户数",-1))])])]),_:1}),e(S,{span:6},{default:a(()=>[l("div",wt,[l("div",kt,[e(c,null,{default:a(()=>[e(u(Te))]),_:1})]),l("div",Mt,[l("h3",null,r(M.value.normalMerchants||0),1),t[17]||(t[17]=l("p",null,"正常商户",-1))])])]),_:1}),e(S,{span:6},{default:a(()=>[l("div",Ct,[l("div",St,[e(c,null,{default:a(()=>[e(u(X))]),_:1})]),l("div",xt,[l("h3",null,r(M.value.slowMerchants||0),1),t[18]||(t[18]=l("p",null,"慢响应商户",-1))])])]),_:1}),e(S,{span:6},{default:a(()=>[l("div",Et,[l("div",Vt,[e(c,null,{default:a(()=>[e(u(ze))]),_:1})]),l("div",Tt,[l("h3",null,r(M.value.circuitBreakerMerchants||0),1),t[19]||(t[19]=l("p",null,"熔断商户",-1))])])]),_:1})]),_:1})]),l("div",zt,[e($,{data:h.value,stripe:""},{default:a(()=>[e(n,{prop:"merchant_name",label:"商户名称","min-width":"150"},{default:a(({row:o})=>[m(r(o.merchant_name||o.merchant_key),1)]),_:1}),e(n,{prop:"merchant_key",label:"商户标识","min-width":"120"}),e(n,{prop:"notify_url",label:"回调地址","min-width":"200","show-overflow-tooltip":""},{default:a(({row:o})=>[l("div",Pt,[l("span",{class:"callback-url",onClick:H=>I(o.notify_url),title:o.notify_url},r(o.notify_url||"-"),9,Qt),o.notify_url?(k(),z(v,{key:0,onClick:H=>I(o.notify_url),type:"text",size:"small",class:"copy-btn",title:"复制回调地址"},{default:a(()=>[e(c,null,{default:a(()=>[e(u(Ye))]),_:1})]),_:1},8,["onClick"])):U("",!0)])]),_:1}),e(n,{prop:"status",label:"状态",width:"100"},{default:a(({row:o})=>[e(O,{type:ne(o.status)},{default:a(()=>[m(r(re(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"failed_requests",label:"失败数",width:"80"}),e(n,{prop:"avg_response_time",label:"平均响应时间",width:"120"},{default:a(({row:o})=>[m(r(o.avg_response_time||0)+"ms ",1)]),_:1}),e(n,{label:"操作",width:"120"},{default:a(({row:o})=>[o.status==="circuit_breaker"?(k(),z(v,{key:0,onClick:H=>le(o.merchant_key),type:"warning",size:"small"},{default:a(()=>[...t[20]||(t[20]=[m(" 重置熔断器 ",-1)])]),_:1},8,["onClick"])):U("",!0),e(v,{onClick:H=>ue(o),type:"primary",size:"small"},{default:a(()=>[...t[21]||(t[21]=[m(" 查看详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1})),[[K,x.value]]),e(L,{class:"notify-logs-card"},{header:a(()=>[l("div",Yt,[t[24]||(t[24]=l("span",null,"通知日志",-1)),l("div",Dt,[e(v,{onClick:b,loading:E.value},{default:a(()=>[e(c,null,{default:a(()=>[e(u(P))]),_:1}),t[22]||(t[22]=m(" 刷新 ",-1))]),_:1},8,["loading"]),e(v,{onClick:t[1]||(t[1]=o=>D.value=!D.value)},{default:a(()=>[e(c,null,{default:a(()=>[e(u(Ie))]),_:1}),t[23]||(t[23]=m(" 筛选 ",-1))]),_:1})])])]),default:a(()=>[D.value?(k(),G("div",Bt,[e(_e,{model:d,inline:""},{default:a(()=>[e(w,{label:"订单号"},{default:a(()=>[e(j,{modelValue:d.order_no,"onUpdate:modelValue":t[2]||(t[2]=o=>d.order_no=o),placeholder:"请输入订单号",clearable:""},null,8,["modelValue"])]),_:1}),e(w,{label:"状态"},{default:a(()=>[e(N,{modelValue:d.status,"onUpdate:modelValue":t[3]||(t[3]=o=>d.status=o),placeholder:"请选择状态",clearable:""},{default:a(()=>[e(i,{label:"全部",value:""}),e(i,{label:"成功",value:"success"}),e(i,{label:"失败",value:"failed"}),e(i,{label:"处理中",value:"pending"})]),_:1},8,["modelValue"])]),_:1}),e(w,{label:"商户标识"},{default:a(()=>[e(j,{modelValue:d.merchant_key,"onUpdate:modelValue":t[4]||(t[4]=o=>d.merchant_key=o),placeholder:"请输入商户标识",clearable:""},null,8,["modelValue"])]),_:1}),e(w,{label:"开始时间"},{default:a(()=>[e(A,{modelValue:d.start_time,"onUpdate:modelValue":t[5]||(t[5]=o=>d.start_time=o),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),e(w,{label:"结束时间"},{default:a(()=>[e(A,{modelValue:d.end_time,"onUpdate:modelValue":t[6]||(t[6]=o=>d.end_time=o),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),e(w,null,{default:a(()=>[e(v,{type:"primary",onClick:q},{default:a(()=>[e(c,null,{default:a(()=>[e(u(Ue))]),_:1}),t[25]||(t[25]=m(" 搜索 ",-1))]),_:1}),e(v,{onClick:ae},{default:a(()=>[e(c,null,{default:a(()=>[e(u(Re))]),_:1}),t[26]||(t[26]=m(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])])):U("",!0),J((k(),z($,{data:R.value,stripe:""},{default:a(()=>[e(n,{prop:"id",label:"ID",width:"80"}),e(n,{prop:"order_no",label:"订单号",width:"200"}),e(n,{prop:"merchant_order_no",label:"商户订单号",width:"200"}),e(n,{prop:"notify_url",label:"回调地址","show-overflow-tooltip":""}),e(n,{prop:"status",label:"状态",width:"100"},{default:a(({row:o})=>[e(O,{type:ie(o.status)},{default:a(()=>[m(r(ce(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"retry_count",label:"重试次数",width:"100"}),e(n,{prop:"http_code",label:"HTTP状态码",width:"120"}),e(n,{prop:"response_data",label:"响应数据","show-overflow-tooltip":""}),e(n,{prop:"created_at",label:"创建时间",width:"180"})]),_:1},8,["data"])),[[K,E.value]]),l("div",Nt,[e(me,{"current-page":_.currentPage,"onUpdate:currentPage":t[7]||(t[7]=o=>_.currentPage=o),"page-size":_.pageSize,"onUpdate:pageSize":t[8]||(t[8]=o=>_.pageSize=o),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:oe},null,8,["current-page","page-size","total"])])]),_:1})])}}},$t=pe(Lt,[["__scopeId","data-v-48be95b4"]]);export{$t as default};
//# sourceMappingURL=callback-CbinRF-k.js.map
