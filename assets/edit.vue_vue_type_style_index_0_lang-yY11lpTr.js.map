{"version":3,"file":"edit.vue_vue_type_style_index_0_lang-yY11lpTr.js","sources":["../../src/pages/admin/user/edit.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { ref, watch } from 'vue'\nimport { ElMessage, ElForm } from 'element-plus'\nimport {\n  addAdminUser, editAdminUser,\n  getAdminUserDetail,\n  getUserGroup,\n} from '@/api/api.ts'\n\nconst visible = ref(false)\nconst formRef = ref<InstanceType<typeof ElForm>>()\nconst treeRef = ref()\n\nconst form = ref({\n  id: 0,\n  nickname: '',\n  username: '',\n  password: '',\n  confirm_password: '',\n  group_id: '',\n  name: '',\n  weight: 0,\n  remark: '',\n  status: 0,\n})\n\nconst userGroupData = ref([])\nconst GetUserGroup = async () => {\n  try {\n    const { data } = await getUserGroup(form.value.id)\n    userGroupData.value = data || []\n  } catch (error) {\n    console.error('获取用户权限失败:', error)\n  }\n}\nconst GetAdminUserDetail = async (id: number) => {\n  try {\n    const { data } = await getAdminUserDetail(id)\n    return data\n  } catch (error) {\n    console.error('获取用户权限失败:', error)\n  }\n}\n\nconst treeProps = {\n  label: 'name',\n  children: 'children',\n}\n\nconst emit = defineEmits<{\n  (event: 'refresh'): void\n}>()\n\n// 定义规则\nconst rules = ref({\n  username: [{ required: true, message: '请输入用户名', trigger: 'blur' }],\n  password: [\n    {\n      required: false, // 密码不强制要求\n      message: '请输入密码',\n      trigger: 'submit',\n    },\n    {\n      min: 6,\n      message: '密码长度不能少于6位',\n      trigger: 'submit',\n    },\n  ],\n  confirm_password: [\n    {\n      required: false, // 确认密码不强制要求\n      message: '请再次输入密码',\n      trigger: 'submit',\n    },\n    {\n      validator: (_rule: any, value: string, callback: any) => {\n        if (value !== form.value.password) {\n          callback(new Error('两次密码输入不一致'))\n        } else {\n          callback()\n        }\n      },\n      trigger: 'submit',\n    },\n  ],\n  group_id: [{ required: true, message: '请选择所属分组', trigger: 'change' }],\n})\n\n// 根据 form.id 动态更新验证规则\nconst updateRules = () => {\n  if (form.value.id === 0) {\n    // 新建用户时密码和确认密码必填\n    rules.value.password[0].required = true\n    rules.value.confirm_password[0].required = true\n  } else {\n    // 编辑时密码和确认密码不必填\n    rules.value.password[0].required = false\n    rules.value.confirm_password[0].required = false\n  }\n}\n\nconst open = async (data = {}) => {\n  const merged = { ...data }\n\n  if (merged.group_id === 0) {\n    (merged as any).group_id = ''\n\n  }\n\n  Object.assign(form.value, merged)\n\n  await GetUserGroup()\n\n  if ((merged as any).id > 0) {\n    const detail = await GetAdminUserDetail((merged as any).id)\n    Object.assign(form.value, detail)\n    form.value.password = ''  // 清空密码字段\n    form.value.confirm_password = ''  // 清空确认密码字段\n  }\n\n  // 更新验证规则\n  updateRules()\n\n  visible.value = true\n}\n\nconst handleSubmit = async () => {\n  await formRef.value?.validate()\n  const checkedKeys = treeRef.value?.getCheckedKeys(true) || []\n  const payload = {\n    ...form.value,\n    rule_ids: checkedKeys,\n  }\n\n  // 如果是编辑状态，去除密码字段\n  if (payload.id > 0 && !form.value.password) {\n    delete (payload as any).password\n  }\n\n  delete (payload as any).confirm_password\n\n  let res\n  if (payload.id == 0) {\n    res = await addAdminUser(payload)\n  } else {\n    res = await editAdminUser(payload)\n  }\n\n  if (res.status) {\n    ElMessage.success(res.message)\n    emit('refresh')\n    visible.value = false\n  }\n}\n// 重置表单数据\nconst resetForm = () => {\n  form.value = {\n    id: 0,\n    nickname: '',\n    username: '',\n    password: '',\n    confirm_password: '',\n    group_id: '',\n    name: '',\n    weight: 0,\n    remark: '',\n    status: 0,\n  }\n}\n\n// 监听 visible 变化，关闭时重置表单\nwatch(visible, (newVal) => {\n  if (!newVal) {\n    resetForm()\n  }\n})\ndefineExpose({ open })\n</script>\n\n\n<template>\n  <el-dialog v-model=\"visible\" title=\"用户分组\" width=\"40%\">\n    <el-form :model=\"form\" label-width=\"100px\" :rules=\"rules\" ref=\"formRef\">\n      <el-form-item label=\"用户名\" prop=\"username\">\n        <el-input v-model=\"form.username\" placeholder=\"请输入用户名\" />\n      </el-form-item>\n\n      <el-form-item label=\"密码\" prop=\"password\">\n        <el-input v-model=\"form.password\" show-password placeholder=\"请输入密码\" />\n      </el-form-item>\n\n      <el-form-item label=\"确认密码\" prop=\"confirm_password\" v-if=\"form.password\">\n        <el-input v-model=\"form.confirm_password\" show-password placeholder=\"请再次输入密码\" />\n      </el-form-item>\n\n      <el-form-item label=\"昵称\" prop=\"nickname\">\n        <el-input v-model=\"form.nickname\" placeholder=\"请输入昵称\" />\n      </el-form-item>\n\n      <el-form-item label=\"所属分组\" prop=\"group_id\">\n        <el-tree-select\n            v-model=\"form.group_id\"\n            :data=\"userGroupData\"\n            :props=\"treeProps\"\n            node-key=\"id\"\n            check-strictly\n            placeholder=\"请选择所属分组\"\n            clearable\n            :filterable=\"true\"\n            :allow-create=\"true\"\n            default-value=\"0\"\n        />\n      </el-form-item>\n\n      <el-form-item label=\"状态\" prop=\"status\">\n        <el-switch v-model=\"form.status\" :active-value=\"1\" :inactive-value=\"0\" />\n      </el-form-item>\n\n      <el-form-item label=\"权重\" prop=\"weight\">\n        <el-input-number v-model=\"form.weight\" :min=\"0\" />\n      </el-form-item>\n\n      <el-form-item label=\"备注\" prop=\"remark\">\n        <el-input v-model=\"form.remark\" type=\"textarea\" />\n      </el-form-item>\n\n      <el-form-item>\n        <el-button type=\"primary\" @click=\"handleSubmit\">提交</el-button>\n      </el-form-item>\n    </el-form>\n  </el-dialog>\n</template>\n\n<style>\n.is-penultimate > .el-tree-node__content {\n  color: #626aef;\n}\n.is-penultimate > .el-tree-node__children > div {\n  display: inline-block;\n  margin-right: 4px;\n\n  &:not(:first-child) .el-tree-node__content {\n    padding-left: 0px !important;\n  }\n  .el-tree-node__content {\n    padding-right: 16px;\n  }\n}\n</style>"],"names":["visible","ref","formRef","treeRef","form","userGroupData","GetUserGroup","data","getUserGroup","error","GetAdminUserDetail","id","getAdminUserDetail","treeProps","emit","__emit","rules","_rule","value","callback","updateRules","open","merged","detail","handleSubmit","_a","checkedKeys","_b","payload","res","addAdminUser","editAdminUser","ElMessage","resetForm","watch","newVal","__expose","_createBlock","_component_el_dialog","$event","_createVNode","_unref","ElForm","_component_el_form_item","_component_el_input","_cache","_component_el_tree_select","_component_el_switch","_component_el_input_number","_component_el_button"],"mappings":"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"}