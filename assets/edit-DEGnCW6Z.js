import{d as ee,h as c,ah as D,M as A,w as o,x as h,am as le,o as m,C as ae,c as y,a as t,u as C,i as te,a9 as se,v as d,D as ie,l as oe,E as ne,b as re,L as ue,e as S,b1 as ce,k as F,b2 as de,m as pe,aO as me,Y as I,F as B,aq as O,ap as _e,ar as fe,j as ve,as as ge,g as he}from"./index-DQjW5cRd.js";/* empty css                *//* empty css            *//* empty css               */import"./form-item-l0sNRNKZ.js";/* empty css              */import{a as ke,b as be,c as we,e as ye}from"./supplier-CQrzdiXB.js";const Ie={"element-loading-text":"加载中..."},Ve={class:"form-tip"},Pe={key:0,class:"duplicate-ip-warning"},Ee={key:1,class:"ip-validation-messages"},xe={class:"form-tip"},De={class:"form-tip"},Ae=ee({__name:"edit",emits:["refresh"],setup(Se,{expose:R,emit:T}){const k=c(!1),U=c(),V=c(!1),f=c(!1),s=c({id:0,supplier_name:"",interface_code:"",status:1,prepayment_check:0,remark:"",telegram_chat_id:"",telegram_chat_ids:[],callback_whitelist_ips:[]}),M=l=>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(l),N=c({supplier_name:[{required:!0,message:"请输入供应商名称",trigger:"blur"}],interface_code:[{required:!0,message:"请输入接口代码",trigger:"blur"}],telegram_chat_id:[],telegram_chat_ids:[{required:!0,message:"请选择管理员",trigger:"change"}],callback_whitelist_ips:[]}),_=c([]),P=c(!1),E=async l=>{P.value=!0;try{const e=await be("/api/v1/admin/supplier/telegram-admins");if(console.log("管理员API响应:",e.data),e.data&&Array.isArray(e.data)){const a=e.data;console.log("管理员数据:",a),_.value=l?a.filter(r=>r.name.includes(l)):a,console.log("过滤后的管理员选项:",_.value)}else if(e.data&&e.data.data&&Array.isArray(e.data.data)){const a=e.data.data;console.log("管理员数据:",a),_.value=l?a.filter(r=>r.name.includes(l)):a,console.log("过滤后的管理员选项:",_.value)}}finally{P.value=!1}},$=l=>{if(!l){s.value.callback_whitelist_ips=[],j();return}const e=l.split("|").map(a=>a.trim()).filter(a=>a.length>0);s.value.callback_whitelist_ips=e,j()},q=l=>{const e=[],a=[],r=new Set;return l.forEach(i=>{r.has(i)?a.push(i):(r.add(i),e.push(i))}),{uniqueIPs:e,removedIPs:a}},v=c(""),g=c([]),x=c([]),j=()=>{const l=v.value.split("|").map(i=>i.trim()).filter(i=>i.length>0),e=new Map,a=[];l.forEach(i=>{const u=e.get(i)||0;e.set(i,u+1),u>0&&a.push(i)}),g.value=[...new Set(a)];const r=[];g.value.length>0&&r.push(`发现重复IP地址：${g.value.join(", ")}`),x.value=r};D(()=>s.value.callback_whitelist_ips,l=>{const e=l.join("|");v.value=e},{immediate:!0}),D(v,l=>{$(l)});const L=async(l={})=>{console.log("打开弹窗，传入数据:",l),z(),V.value=!0;try{if(l.id&&l.id>0){const e=await ke("/api/v1/admin/supplier/detail",l.id);if(console.log("供应商详情响应:",e.data),e.data&&e.data.id){const a=e.data;let r=[];if(a.callback_whitelist_ips&&(Array.isArray(a.callback_whitelist_ips)?r=a.callback_whitelist_ips:typeof a.callback_whitelist_ips=="string"&&(r=a.callback_whitelist_ips.split("|").filter(i=>i.trim()))),Object.assign(s.value,{id:a.id||0,supplier_name:a.supplier_name||"",interface_code:a.interface_code||"",status:a.status??1,prepayment_check:a.prepayment_check??0,remark:a.remark||"",telegram_chat_id:a.telegram_chat_id||"",telegram_chat_ids:a.telegram_chat_ids||[],callback_whitelist_ips:r}),await E(""),s.value.telegram_chat_ids.length>0){console.log("已选中的管理员ID:",s.value.telegram_chat_ids),console.log("当前管理员选项:",_.value);const i=s.value.telegram_chat_ids,u=_.value.map(b=>b.id),p=i.filter(b=>!u.includes(b));console.log("缺失的管理员ID:",p),p.length>0&&await E("")}}else{console.log("供应商详情获取失败，响应数据:",e.data),h.error("获取供应商详情失败：数据格式不正确");return}}else Object.assign(s.value,{id:l.id||0,supplier_name:l.supplier_name||"",interface_code:l.interface_code||"",status:l.status??1,prepayment_check:l.prepayment_check??0,remark:l.remark||"",telegram_chat_id:l.telegram_chat_id||"",telegram_chat_ids:l.telegram_chat_ids||[],callback_whitelist_ips:l.callback_whitelist_ips||[]});k.value=!0}catch(e){console.error("获取供应商详情异常:",e),h.error("获取供应商详情失败: "+((e==null?void 0:e.message)||e))}finally{V.value=!1}},W=async()=>{var l;if(!f.value)try{f.value=!0,await((l=U.value)==null?void 0:l.validate());const e=[];if(s.value.callback_whitelist_ips.forEach(p=>{M(p)||e.push(p)}),e.length>0){h.error(`以下IP地址格式无效：${e.join(", ")}`);return}const{uniqueIPs:a,removedIPs:r}=q(s.value.callback_whitelist_ips);r.length>0&&h.warning(`已自动移除重复IP地址：${r.join(", ")}`);const i={...s.value,callback_whitelist_ips:a};let u;s.value.id===0?u=await we("/api/v1/admin/supplier/add",i):u=await ye("/api/v1/admin/supplier/edit",i),u&&u.status===!0?(h.success(u.message||"操作成功"),Y("refresh"),k.value=!1):h.error((u==null?void 0:u.message)||"操作失败")}catch(e){console.error("提交失败:",e)}finally{f.value=!1}},z=()=>{s.value={id:0,supplier_name:"",interface_code:"",status:1,prepayment_check:0,remark:"",telegram_chat_id:"",telegram_chat_ids:[],callback_whitelist_ips:[]},v.value=""};D(k,(l,e)=>{e===!0&&l===!1&&(console.log("弹窗关闭，重置表单"),z())});const Y=T;return R({open:L}),(l,e)=>{const a=se,r=oe,i=ie,u=ue,p=re,b=ne,w=ce,G=pe,H=fe,J=_e,K=ve,Q=le,X=ge;return m(),A(Q,{modelValue:k.value,"onUpdate:modelValue":e[8]||(e[8]=n=>k.value=n),title:"供应商",size:"50%"},{default:o(()=>[ae((m(),y("div",Ie,[t(C(te),{model:s.value,rules:N.value,ref_key:"formRef",ref:U,"label-width":"150px"},{default:o(()=>[t(a,{"content-position":"left"},{default:o(()=>[...e[9]||(e[9]=[d("基础信息",-1)])]),_:1}),t(i,{label:"供应商名称",prop:"supplier_name"},{default:o(()=>[t(r,{modelValue:s.value.supplier_name,"onUpdate:modelValue":e[0]||(e[0]=n=>s.value.supplier_name=n),placeholder:"请输入供应商名称"},null,8,["modelValue"])]),_:1}),t(i,{label:"接口代码",prop:"interface_code"},{default:o(()=>[t(r,{modelValue:s.value.interface_code,"onUpdate:modelValue":e[1]||(e[1]=n=>s.value.interface_code=n),placeholder:"请输入接口代码"},null,8,["modelValue"])]),_:1}),t(b,{gutter:20},{default:o(()=>[t(p,{span:12},{default:o(()=>[t(i,{label:"状态",prop:"status"},{default:o(()=>[t(u,{modelValue:s.value.status,"onUpdate:modelValue":e[2]||(e[2]=n=>s.value.status=n),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1})]),_:1}),t(p,{span:12},{default:o(()=>[t(i,{label:"预付检验",prop:"prepayment_check"},{default:o(()=>[t(u,{modelValue:s.value.prepayment_check,"onUpdate:modelValue":e[3]||(e[3]=n=>s.value.prepayment_check=n),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(i,{label:"绑定群组",prop:"telegram_chat_id"},{default:o(()=>[t(r,{modelValue:s.value.telegram_chat_id,"onUpdate:modelValue":e[4]||(e[4]=n=>s.value.telegram_chat_id=n),placeholder:"请输入群组ID（选填）"},null,8,["modelValue"]),S("div",Ve,[t(w,{type:"info",size:"small"},{default:o(()=>[...e[10]||(e[10]=[d(" 群组ID为选填项，用于接收供应商相关通知 ",-1)])]),_:1})])]),_:1}),t(i,{label:"备注",prop:"remark"},{default:o(()=>[t(r,{modelValue:s.value.remark,"onUpdate:modelValue":e[5]||(e[5]=n=>s.value.remark=n),type:"textarea"},null,8,["modelValue"])]),_:1}),t(a,{"content-position":"left"},{default:o(()=>[...e[11]||(e[11]=[d("回调IP白名单",-1)])]),_:1}),t(i,{label:"IP白名单",prop:"callback_whitelist_ips"},{default:o(()=>[t(r,{modelValue:v.value,"onUpdate:modelValue":e[6]||(e[6]=n=>v.value=n),type:"textarea",rows:4,placeholder:"请输入IP地址，多个IP用|分隔，例如：192.168.1.1|192.168.1.2|10.0.0.1",style:de({border:g.value.length>0?"1px solid #f56c6c":"1px solid #dcdfe6"})},null,8,["modelValue","style"]),g.value.length>0?(m(),y("div",Pe,[t(w,{type:"warning",size:"small"},{default:o(()=>[t(G,null,{default:o(()=>[t(C(me))]),_:1}),d(" 发现重复IP地址："+I(g.value.join(", ")),1)]),_:1})])):F("",!0),x.value.length>0?(m(),y("div",Ee,[(m(!0),y(B,null,O(x.value,(n,Z)=>(m(),A(w,{key:Z,type:"warning",size:"small",class:"validation-message"},{default:o(()=>[d(I(n),1)]),_:2},1024))),128))])):F("",!0),S("div",xe,[t(w,{type:"info",size:"small"},{default:o(()=>[...e[12]||(e[12]=[d(" 多个IP地址用|分隔，支持IPv4格式，选填。例如：192.168.1.1|192.168.1.2|10.0.0.1 ",-1)])]),_:1})])]),_:1}),t(a,{"content-position":"left"},{default:o(()=>[...e[13]||(e[13]=[d("绑定管理员",-1)])]),_:1}),t(i,{label:"管理员",prop:"telegram_chat_ids"},{default:o(()=>[t(J,{modelValue:s.value.telegram_chat_ids,"onUpdate:modelValue":e[7]||(e[7]=n=>s.value.telegram_chat_ids=n),multiple:"",filterable:"",remote:"","reserve-keyword":"",placeholder:"搜索并选择管理员","remote-method":E,loading:P.value,clearable:"","collapse-tags":"","collapse-tags-tooltip":""},{default:o(()=>[(m(!0),y(B,null,O(_.value,n=>(m(),A(H,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),S("div",De,[t(w,{type:"info",size:"small"},{default:o(()=>[d(" 已选择 "+I(s.value.telegram_chat_ids.length)+" 个管理员 ",1)]),_:1})])]),_:1}),t(i,null,{default:o(()=>[t(K,{type:"primary",onClick:W,loading:f.value,disabled:f.value},{default:o(()=>[d(I(f.value?"提交中...":"提交"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model","rules"])])),[[X,V.value]])]),_:1},8,["modelValue"])}}}),Re=he(Ae,[["__scopeId","data-v-ba6f21a3"]]);export{Re as default};
//# sourceMappingURL=edit-DEGnCW6Z.js.map
