{"version":3,"file":"merchant-assignment-B5NYxrS9.js","sources":["../../src/pages/product/merchant-assignment.vue"],"sourcesContent":["<template>\n  <el-dialog\n    v-model=\"visible\"\n    title=\"分配给商户\"\n    width=\"80%\"\n    :before-close=\"handleClose\"\n    destroy-on-close\n  >\n    <div class=\"merchant-assignment\">\n      <!-- 产品信息 -->\n      <div class=\"product-info\" v-if=\"productInfo\">\n        <el-card shadow=\"never\" class=\"mb-4\">\n          <div class=\"product-header\">\n            <h3>{{ productInfo.product_name }}</h3>\n            <div class=\"product-details\">\n              <span class=\"detail-item\">\n                <strong>对接编号：</strong>{{ productInfo.external_code }}\n              </span>\n              <span class=\"detail-item\">\n                <strong>默认费率：</strong>{{ (productInfo.default_rate_bp / 100).toFixed(2) }}%\n              </span>\n            </div>\n          </div>\n        </el-card>\n      </div>\n\n      <!-- 商户列表 -->\n      <div class=\"merchant-list\">\n        <el-table\n          :data=\"merchantList\"\n          border\n          stripe\n          max-height=\"500\"\n          v-loading=\"loading\"\n        >\n          <el-table-column prop=\"merchant_name\" label=\"商户名称\" align=\"center\" min-width=\"200\"/>\n          <el-table-column label=\"状态\" align=\"center\" min-width=\"100\">\n            <template #default=\"{ row }\">\n              <el-switch\n                v-model=\"row.is_assigned\"\n                :active-value=\"true\"\n                :inactive-value=\"false\"\n                @change=\"handleStatusChange(row)\"\n                :disabled=\"row.status !== 1\"\n              />\n            </template>\n          </el-table-column>\n          <el-table-column label=\"商户费率\" align=\"center\" min-width=\"150\">\n            <template #default=\"{ row }\">\n              <div class=\"rate-edit\">\n                <el-input-number\n                  v-model=\"row.merchant_rate_percent\"\n                  :min=\"0\"\n                  :max=\"100\"\n                  :precision=\"2\"\n                  :step=\"0.01\"\n                  size=\"small\"\n                  @change=\"handleRateChange(row)\"\n                />\n                <span class=\"rate-unit\">%</span>\n              </div>\n            </template>\n          </el-table-column>\n        </el-table>\n      </div>\n    </div>\n\n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"handleClose\">关闭</el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script lang=\"ts\" setup>\nimport { ref } from 'vue';\nimport { ElMessage } from 'element-plus';\nimport { assignProductToMerchant, getMerchantList, updateMerchantRate } from '@/api/product';\n\n// 定义接口\ninterface ProductInfo {\n  id: number;\n  product_name: string;\n  external_code: string;\n  default_rate_bp: number;\n}\n\ninterface MerchantInfo {\n  id: number;\n  merchant_name: string;\n  status: number;\n  default_rate_bp: number;\n  merchant_rate: number;\n  merchant_rate_percent: number;\n  is_assigned: boolean;\n}\n\n// 响应式数据\nconst visible = ref(false);\nconst loading = ref(false);\nconst productInfo = ref<ProductInfo | null>(null);\nconst merchantList = ref<MerchantInfo[]>([]);\n\n// 打开对话框\nconst open = (product: ProductInfo) => {\n  productInfo.value = product;\n  visible.value = true;\n  loadMerchantList();\n};\n\n// 加载商户列表\nconst loadMerchantList = async () => {\n  if (!productInfo.value) return;\n  \n  loading.value = true;\n  try {\n    console.log('正在获取商户列表，产品ID:', productInfo.value.id);\n    const res = await getMerchantList(productInfo.value.id);\n    console.log('API响应:', res);\n    \n    if (res.status) {\n      console.log('商户数据:', res.data.merchants);\n      merchantList.value = res.data.merchants.map((merchant: any) => ({\n        ...merchant,\n        merchant_rate: merchant.merchant_rate || merchant.default_rate_bp,\n        merchant_rate_percent: (merchant.merchant_rate || merchant.default_rate_bp) / 100,\n        is_assigned: merchant.is_assigned || false\n      }));\n      console.log('处理后的商户列表:', merchantList.value);\n    } else {\n      console.error('API返回错误:', res.message);\n      ElMessage.error(res.message || '获取商户列表失败');\n    }\n  } catch (error) {\n    console.error('获取商户列表失败:', error);\n    ElMessage.error('获取商户列表失败');\n  } finally {\n    loading.value = false;\n  }\n};\n\n// 处理状态变化\nconst handleStatusChange = async (row: MerchantInfo) => {\n  if (!productInfo.value) return;\n  \n  try {\n    if (row.is_assigned) {\n      // 开启分配\n      const res = await assignProductToMerchant({\n        product_id: productInfo.value.id,\n        merchant_id: row.id,\n        merchant_rate: row.merchant_rate\n      });\n      \n      if (res.status) {\n        ElMessage.success('分配成功');\n      } else {\n        ElMessage.error(res.message || '分配失败');\n        row.is_assigned = false; // 回滚状态\n      }\n    } else {\n      // 关闭分配\n      const res = await updateMerchantRate({\n        product_id: productInfo.value.id,\n        merchant_id: row.id,\n        merchant_rate: 0\n      });\n      \n      if (res.status) {\n        ElMessage.success('已取消分配');\n      } else {\n        ElMessage.error(res.message || '取消分配失败');\n        row.is_assigned = true; // 回滚状态\n      }\n    }\n  } catch (error) {\n    console.error('状态更新失败:', error);\n    ElMessage.error('操作失败');\n    // 回滚状态\n    row.is_assigned = !row.is_assigned;\n  }\n};\n\n// 处理费率变化\nconst handleRateChange = async (row: MerchantInfo) => {\n  if (!productInfo.value) return;\n  \n  // 将百分比转换为存储格式\n  row.merchant_rate = Math.round(row.merchant_rate_percent * 100);\n  console.log('费率变化:', row.merchant_name, '百分比:', row.merchant_rate_percent, '存储值:', row.merchant_rate);\n  \n  try {\n    const res = await assignProductToMerchant({\n      product_id: productInfo.value.id,\n      merchant_id: row.id,\n      merchant_rate: row.merchant_rate\n    });\n    \n    if (res.status) {\n      ElMessage.success('费率更新成功');\n    } else {\n      ElMessage.error(res.message || '费率更新失败');\n    }\n  } catch (error) {\n    console.error('费率更新失败:', error);\n    ElMessage.error('费率更新失败');\n  }\n};\n\n\n// 关闭对话框\nconst handleClose = () => {\n  visible.value = false;\n  productInfo.value = null;\n  merchantList.value = [];\n};\n\n// 暴露方法\ndefineExpose({\n  open\n});\n</script>\n\n<style lang=\"scss\" scoped>\n.merchant-assignment {\n  .product-info {\n    .product-header {\n      h3 {\n        margin: 0 0 12px 0;\n        color: #303133;\n        font-size: 18px;\n      }\n      \n      .product-details {\n        display: flex;\n        gap: 24px;\n        \n        .detail-item {\n          color: #606266;\n          font-size: 14px;\n          \n          strong {\n            color: #303133;\n          }\n        }\n      }\n    }\n  }\n  \n  .merchant-list {\n    .rate-edit {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      \n      .rate-unit {\n        font-size: 12px;\n        color: #909399;\n        min-width: 20px;\n      }\n    }\n  }\n}\n\n.dialog-footer {\n  text-align: right;\n}\n</style>\n"],"names":["visible","ref","loading","productInfo","merchantList","open","product","loadMerchantList","res","getMerchantList","merchant","ElMessage","error","handleStatusChange","row","assignProductToMerchant","updateMerchantRate","handleRateChange","handleClose","__expose","_createBlock","_component_el_dialog","$event","_createElementVNode","_hoisted_9","_createVNode","_component_el_button","_cache","_hoisted_1","_openBlock","_createElementBlock","_hoisted_2","_component_el_card","_hoisted_3","_toDisplayString","_hoisted_4","_hoisted_5","_createTextVNode","_hoisted_6","_hoisted_7","_component_el_table","_component_el_table_column","_withCtx","_component_el_switch","_hoisted_8","_component_el_input_number"],"mappings":"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"}