{"version":3,"file":"edit-Cl5ZJedT.js","sources":["../../src/pages/merchant/edit.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { ref, watch, computed } from 'vue'\nimport { ElMessage, ElForm } from 'element-plus'\n\nimport {addMerchant, editMerchant, getMerchantDetail} from \"@/api/merchant.ts\";\n\nconst visible = ref(false)\nconst formRef = ref<InstanceType<typeof ElForm>>()\nconst loading = ref(false)\n\nconst form = ref({\n  id: 0,\n  login_account: \"\",\n  merchant_name: \"\",\n  status: 1,\n  withdraw_config_type: 1,\n  withdraw_fee: 0,\n  withdraw_rate: 0,\n  whitelist_ips: \"\",\n})\n\n// 计算属性：根据配置类型判断是否显示提现手续费\nconst showWithdrawFee = computed(() => {\n  return form.value.withdraw_config_type === 2 // 单笔固定\n})\n\n// 计算属性：根据配置类型判断是否显示提现费率\nconst showWithdrawRate = computed(() => {\n  return form.value.withdraw_config_type === 3 // 单笔比例\n})\n\n// 金额格式化：分转元\nconst formatAmount = (amount: number) => {\n  return (amount / 100).toFixed(2)\n}\n\n// 金额格式化：元转分\nconst parseAmount = (amount: string) => {\n  return Math.round(parseFloat(amount) * 100)\n}\n\n// 费率格式化：百分比显示\nconst formatRate = (rate: number) => {\n  return (rate / 100).toFixed(2)\n}\n\n// 费率格式化：百分比转存储格式\nconst parseRate = (rate: string) => {\n  return Math.round(parseFloat(rate) * 100)\n}\n\nconst emit = defineEmits<{\n  (event: 'refresh'): void\n}>()\n\n// 定义规则\nconst rules = ref({\n  login_account: [{ required: true, message: '请输入登录账号', trigger: 'blur' }],\n  merchant_name: [{ required: true, message: '请输入商户名称', trigger: 'blur' }],\n  withdraw_config_type: [{ required: true, message: '请选择提现配置类型', trigger: 'change' }],\n  withdraw_fee: [\n    {\n      required: false,\n      message: '请输入提现手续费',\n      trigger: 'blur',\n      validator: (_rule: any, value: any, callback: any) => {\n        if (form.value.withdraw_config_type === 2) {\n          if (!value || isNaN(Number(value)) || Number(value) < 0) {\n            callback(new Error('请输入有效的提现手续费'))\n          } else {\n            callback()\n          }\n        } else {\n          callback()\n        }\n      }\n    }\n  ],\n  withdraw_rate: [\n    {\n      required: false,\n      message: '请输入提现费率',\n      trigger: 'blur',\n      validator: (_rule: any, value: any, callback: any) => {\n        if (form.value.withdraw_config_type === 3) {\n          if (!value || isNaN(Number(value)) || Number(value) < 0) {\n            callback(new Error('请输入有效的提现费率'))\n          } else {\n            callback()\n          }\n        } else {\n          callback()\n        }\n      }\n    }\n  ],\n})\n\nconst open = async (data: any = {}) => {\n  console.log('🔍 EditForm open called', { \n    data, \n    visible: visible.value,\n    loading: loading.value \n  });\n  \n  // 先重置表单\n  resetForm()\n  loading.value = true\n  \n  try {\n    // 确保 data 不为 null 或 undefined\n    const safeData = data || {}\n    let merged: any = { ...safeData }\n    \n    // 检查是否有有效的 id 且大于 0\n    if (safeData && safeData.id && typeof safeData.id === 'number' && safeData.id > 0) {\n      // 编辑模式：从详情获取数据\n      try {\n        const res = await getMerchantDetail('/api/v1/admin/merchant/detail', safeData.id)\n        if (res.status && res.data) {\n          merged = { ...res.data }\n        } else {\n          ElMessage.error('获取商户详情失败')\n          return\n        }\n      } catch (error) {\n        ElMessage.error('获取商户详情失败')\n        return\n      }\n    }\n\n    // 处理金额字段：分转元显示（仅在编辑模式下）\n    if (safeData && safeData.id && typeof safeData.id === 'number' && safeData.id > 0) {\n      if (merged.withdraw_fee) {\n        merged.withdraw_fee = formatAmount(merged.withdraw_fee)\n      }\n      // 处理费率字段：转换为百分比显示\n      if (merged.withdraw_rate) {\n        merged.withdraw_rate = formatRate(merged.withdraw_rate)\n      }\n    }\n\n    // 只更新有值的字段\n    Object.keys(merged).forEach(key => {\n      if (merged[key] !== undefined && merged[key] !== null && merged[key] !== '') {\n        (form.value as any)[key] = merged[key]\n      }\n    })\n    \n    // 如果是新增模式，确保表单有正确的默认值\n    if (!safeData || !safeData.id || safeData.id <= 0) {\n      form.value.id = 0\n      form.value.status = 1\n      form.value.withdraw_fee = 0\n      form.value.withdraw_rate = 0\n      form.value.withdraw_config_type = 1\n      form.value.whitelist_ips = \"\"\n    }\n    visible.value = true\n  } catch (error) {\n    ElMessage.error('加载数据失败')\n  } finally {\n    loading.value = false\n  }\n}\n\nconst handleSubmit = async () => {\n  try {\n    await formRef.value?.validate()\n\n    // 准备提交数据\n    const submitData = { ...form.value }\n    \n    // 根据配置类型处理相应字段\n    if (form.value.withdraw_config_type === 2) {\n      // 单笔固定：处理提现手续费\n      submitData.withdraw_fee = parseAmount(submitData.withdraw_fee.toString())\n      submitData.withdraw_rate = 0 // 费率设为0\n    } else if (form.value.withdraw_config_type === 3) {\n      // 单笔比例：处理提现费率\n      submitData.withdraw_rate = parseRate(submitData.withdraw_rate.toString())\n      submitData.withdraw_fee = 0 // 手续费设为0\n    } else {\n      // 系统规则：都设为0\n      submitData.withdraw_fee = 0\n      submitData.withdraw_rate = 0\n    }\n\n    loading.value = true\n    let res: any\n    if (form.value.id > 0) {\n      res = await editMerchant('/api/v1/admin/merchant/edit', submitData)\n    } else {\n      res = await addMerchant('/api/v1/admin/merchant/add', submitData)\n    }\n\n    if (res.status) {\n      ElMessage.success(res.message || '操作成功')\n      emit('refresh')\n      visible.value = false\n    } else {\n      ElMessage.error(res.message || '操作失败')\n    }\n  } catch (error) {\n    ElMessage.error('提交失败，请检查表单信息')\n  } finally {\n    loading.value = false\n  }\n}\n\n// 重置表单数据\nconst resetForm = () => {\n  form.value = {\n    id: 0,\n    login_account: \"\",\n    merchant_name: \"\",\n    status: 1,\n    withdraw_config_type: 1,\n    withdraw_fee: 0,\n    withdraw_rate: 0,\n    whitelist_ips: \"\",\n  }\n}\n\n// 监听 visible 变化，关闭时重置表单\nwatch(visible, (newVal, oldVal) => {\n  // 只有在从 true 变为 false 时才重置表单\n  if (oldVal === true && newVal === false) {\n    resetForm()\n  }\n})\n\ndefineExpose({ open })\n</script>\n\n<template>\n  <el-drawer v-model=\"visible\" :title=\"form.id > 0 ? '编辑商户' : '新增商户'\" size=\"50%\">\n    <div v-loading=\"loading\" element-loading-text=\"加载中...\">\n      <el-form :model=\"form\" :rules=\"rules\" ref=\"formRef\" label-width=\"150px\">\n        <!-- 基本信息 -->\n        <el-divider content-position=\"left\">基本信息</el-divider>\n        <el-form-item label=\"登录账号\" prop=\"login_account\">\n          <el-input v-model=\"form.login_account\" placeholder=\"请输入登录账号\" />\n        </el-form-item>\n        \n        <el-form-item label=\"商户名称\" prop=\"merchant_name\">\n          <el-input v-model=\"form.merchant_name\" placeholder=\"请输入商户名称\" />\n        </el-form-item>\n        \n        <el-form-item label=\"状态\" prop=\"status\">\n          <el-switch v-model=\"form.status\" :active-value=\"1\" :inactive-value=\"0\" />\n        </el-form-item>\n\n        <!-- 提现配置 -->\n        <el-divider content-position=\"left\">提现配置</el-divider>\n        <el-form-item label=\"配置类型\" prop=\"withdraw_config_type\">\n          <el-select v-model=\"form.withdraw_config_type\" placeholder=\"请选择配置类型\" style=\"width: 100%\">\n            <el-option label=\"系统规则\" :value=\"1\" />\n            <el-option label=\"单笔固定\" :value=\"2\" />\n            <el-option label=\"单笔比例\" :value=\"3\" />\n          </el-select>\n        </el-form-item>\n\n        <!-- 根据配置类型动态显示输入框 -->\n        <el-form-item \n          v-if=\"showWithdrawFee\" \n          label=\"提现手续费\" \n          prop=\"withdraw_fee\"\n        >\n          <el-input v-model=\"form.withdraw_fee\" placeholder=\"单位：元\">\n            <template #append>元</template>\n          </el-input>\n        </el-form-item>\n\n        <el-form-item \n          v-if=\"showWithdrawRate\" \n          label=\"提现费率\" \n          prop=\"withdraw_rate\"\n        >\n          <el-input v-model=\"form.withdraw_rate\" placeholder=\"例如：1.5表示1.5%\">\n            <template #append>%</template>\n          </el-input>\n        </el-form-item>\n\n        <!-- 白名单IP -->\n        <el-form-item label=\"白名单IP\">\n          <el-input \n            v-model=\"form.whitelist_ips\" \n            type=\"textarea\" \n            placeholder=\"请输入IP地址，多个IP用|分隔，例如：192.168.1.1|192.168.1.2|10.0.0.1\"\n            :rows=\"3 as number\"\n          />\n        </el-form-item>\n\n        <el-form-item>\n          <el-button type=\"primary\" @click=\"handleSubmit\" :loading=\"loading\">提交</el-button>\n          <el-button @click=\"visible = false\">取消</el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n  </el-drawer>\n</template>\n\n<style scoped>\n.el-form-item {\n  margin-bottom: 20px;\n}\n\n:deep(.el-divider__text) {\n  font-weight: 600;\n  color: #409eff;\n}\n\n:deep(.el-form-item__label) {\n  font-weight: 500;\n}\n\n:deep(.el-input-number) {\n  width: 100%;\n}\n\n:deep(.el-select) {\n  width: 100%;\n}\n\n:deep(.el-textarea) {\n  width: 100%;\n}\n</style>\n"],"names":["visible","ref","formRef","loading","form","showWithdrawFee","computed","showWithdrawRate","formatAmount","amount","parseAmount","formatRate","rate","parseRate","emit","__emit","rules","_rule","value","callback","open","data","resetForm","safeData","merged","res","getMerchantDetail","ElMessage","key","handleSubmit","_a","submitData","editMerchant","addMerchant","watch","newVal","oldVal","__expose","_createBlock","_component_el_drawer","$event","_withDirectives","_openBlock","_createElementBlock","_hoisted_1","_createVNode","_unref","ElForm","_component_el_divider","_cache","_component_el_form_item","_component_el_input","_component_el_switch","_component_el_select","_component_el_option","_component_el_button"],"mappings":"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"}