{"version":3,"file":"pool-BuFrFqju.js","sources":["../../src/pages/product/pool.vue"],"sourcesContent":["<template>\n  <el-dialog v-model=\"visible\" :title=\"dialogTitle\" width=\"70%\" :before-close=\"handleClose\">\n    <div v-loading=\"loading\" element-loading-text=\"加载中...\">\n      <!-- 使用说明 -->\n      <el-alert\n        type=\"info\"\n        :closable=\"false\"\n        show-icon\n        class=\"mb-4\"\n      >\n        <template #default>\n          <div class=\"usage-instructions\">\n            <p><strong>轮询池管理说明：</strong></p>\n            <ul>\n              <li>轮询池中的通道会参与轮询调度，可选通道不会参与</li>\n              <li>可以通过搜索框快速查找特定通道</li>\n              <li>操作完成后请点击\"保存\"按钮确认更改</li>\n            </ul>\n          </div>\n        </template>\n      </el-alert>\n\n      <!-- 当前产品信息 -->\n      <div v-if=\"currentProduct\" class=\"current-product-info mb-4\">\n        <el-card>\n          <template #header>\n            <span>当前产品信息</span>\n          </template>\n          <div class=\"product-info\">\n            <span><strong>产品名称：</strong>{{ currentProduct.product_name }}</span>\n            <span><strong>对接编号：</strong>{{ currentProduct.external_code }}</span>\n\n          </div>\n        </el-card>\n      </div>\n\n      <!-- Transfer 穿梭框 -->\n      <div class=\"transfer-container\">\n        <el-transfer\n          v-model=\"selectedProducts\"\n          :data=\"transferData\"\n          :titles=\"['可选通道 (供应商-通道-成本费率)', '轮询池 (供应商-通道-成本费率)']\"\n          :button-texts=\"['移除', '分配']\"\n          :format=\"{\n            noChecked: '${total}',\n            hasChecked: '${checked}/${total}'\n          }\"\n          filterable\n          :filter-placeholder=\"'请输入产品名称'\"\n          @change=\"handleTransferChange\"\n        >\n          <template #default=\"{ option }\">\n            <div class=\"product-item\" :class=\"{ 'disabled-channel': !option.is_enabled }\">\n              <div class=\"product-info\">\n                <span class=\"channel-name\">\n                  {{ option.display_name || `${option.supplier_name}-${option.channel_name}-${option.cost_rate}%` }}\n                  <span class=\"weight-badge\" v-if=\"option.weight > 0\">权重:{{ option.weight }}</span>\n                </span>\n                <span v-if=\"!option.is_enabled\" class=\"status-badge\">未启用</span>\n              </div>\n            </div>\n          </template>\n        </el-transfer>\n      </div>\n    </div>\n\n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"handleClose\">取消</el-button>\n        <el-button type=\"primary\" @click=\"handleSave\" :loading=\"saving\">保存</el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, computed, watch } from 'vue'\nimport { ElMessage, ElMessageBox } from 'element-plus'\nimport { getPoolList, updatePool } from '@/api/product'\n\nconst visible = ref(false)\nconst loading = ref(false)\nconst saving = ref(false)\nconst currentProduct = ref<any>(null)\nconst poolData = ref({\n  assigned: [] as any[],\n  unassigned: [] as any[]\n})\n\n// 计算属性：对话框标题\nconst dialogTitle = computed(() => {\n  if (currentProduct.value) {\n    return `轮询池管理 - ${currentProduct.value.product_name}`\n  }\n  return '轮询池管理'\n})\n\nconst emit = defineEmits<{\n  (event: 'refresh'): void\n}>()\n\n// 计算属性：生成Transfer组件需要的数据格式\nconst transferData = computed(() => {\n  const allChannels = [...poolData.value.unassigned, ...poolData.value.assigned]\n  \n  return allChannels.map((channel: any) => ({\n    key: channel.key || channel.channel_id,\n    label: channel.display_name || `${channel.supplier_name}-${channel.channel_name}-${channel.cost_rate}%`,\n    channel_id: channel.channel_id,\n    channel_name: channel.channel_name,\n    cost_rate: channel.cost_rate,\n    weight: channel.weight,\n    min_amount: channel.min_amount,\n    max_amount: channel.max_amount,\n    interface_code: channel.interface_code,\n    supplier_name: channel.supplier_name,\n    display_name: channel.display_name,\n    status: channel.status,\n    is_enabled: channel.is_enabled,\n    disabled: false // 保持可选择，但通过样式区分状态\n  }))\n})\n\n// 计算属性：已选择的通道ID（已分配的通道）\nconst selectedProducts = computed({\n  get() {\n    return poolData.value.assigned.map((channel: any) => channel.key || channel.channel_id)\n  },\n  set(value: any[]) {\n    // 更新assigned和unassigned数据\n    const allChannels = [...poolData.value.unassigned, ...poolData.value.assigned]\n    const selectedChannels = allChannels.filter((channel: any) => \n      value.includes(channel.key || channel.channel_id)\n    )\n    const unselectedChannels = allChannels.filter((channel: any) => \n      !value.includes(channel.key || channel.channel_id)\n    )\n    \n    poolData.value.assigned = selectedChannels\n    poolData.value.unassigned = unselectedChannels\n  }\n})\n\n\n// Transfer变化处理\nconst handleTransferChange = (value: any[], direction: string, movedKeys: any[]) => {\n  console.log('Transfer changed:', { value, direction, movedKeys })\n  console.log('Current poolData:', poolData.value)\n  console.log('Current selectedProducts:', selectedProducts.value)\n}\n\n// 打开对话框\nconst open = async (product: any = null) => {\n  console.log('Opening pool dialog with product:', product)\n  currentProduct.value = product\n  visible.value = true\n  await loadPoolData()\n}\n\n// 加载轮询池数据\nconst loadPoolData = async () => {\n  console.log('loadPoolData called, currentProduct:', currentProduct.value)\n  if (!currentProduct.value?.id) {\n    console.log('No product ID, skipping API call')\n    return\n  }\n  \n  loading.value = true\n  try {\n    const url = `/api/v1/admin/product/pool/list?product_id=${currentProduct.value.id}`\n    console.log('Making API request to:', url)\n    const res = await getPoolList(url)\n    console.log('API response:', res)\n    const { status, data: responseData } = res\n    if (status && responseData) {\n      poolData.value = {\n        assigned: responseData.assigned_channels || [],\n        unassigned: responseData.available_channels || []\n      }\n      console.log('Pool data updated:', poolData.value)\n    } else {\n      ElMessage.error('加载轮询池数据失败')\n    }\n  } catch (error) {\n    console.error('API request failed:', error)\n    ElMessage.error('加载轮询池数据失败')\n  } finally {\n    loading.value = false\n  }\n}\n\n// 保存更改\nconst handleSave = async () => {\n  try {\n    await ElMessageBox.confirm('确定要保存轮询池的更改吗？', '确认保存', {\n      confirmButtonText: '确定',\n      cancelButtonText: '取消',\n      type: 'warning'\n    })\n\n    saving.value = true\n\n    // 使用批量更新API，一次性更新所有通道\n    await updatePool('/api/v1/admin/product/pool/update', { \n      product_id: currentProduct.value.id,\n      channel_ids: selectedProducts.value \n    })\n\n    ElMessage.success('保存成功')\n    emit('refresh')\n    visible.value = false\n  } catch (error) {\n    if (error !== 'cancel') {\n      ElMessage.error('保存失败')\n    }\n  } finally {\n    saving.value = false\n  }\n}\n\n// 关闭对话框\nconst handleClose = () => {\n  visible.value = false\n  currentProduct.value = null\n}\n\n// 监听visible变化，重置数据\nwatch(visible, (newVal) => {\n  if (!newVal) {\n    currentProduct.value = null\n    poolData.value = {\n      assigned: [],\n      unassigned: []\n    }\n  }\n})\n\ndefineExpose({ open })\n</script>\n\n<style lang=\"scss\" scoped>\n.usage-instructions {\n  ul {\n    margin: 8px 0 0 0;\n    padding-left: 20px;\n    \n    li {\n      margin-bottom: 4px;\n      line-height: 1.5;\n    }\n  }\n}\n\n.current-product-info {\n  .product-info {\n    display: flex;\n    gap: 20px;\n    flex-wrap: wrap;\n    \n    span {\n      display: flex;\n      align-items: center;\n      gap: 4px;\n    }\n  }\n}\n\n.transfer-container {\n  display: flex;\n  justify-content: center;\n  width: 100%;\n  flex-direction: row;\n}\n\n.product-item {\n  padding: 6px 0;\n  \n  .product-info {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    font-weight: 500;\n    font-size: 13px;\n    line-height: 1.4;\n    \n    .channel-name {\n      color: #409EFF;\n      background: linear-gradient(135deg, #409EFF, #67C23A);\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      \n      .weight-badge {\n        font-size: 10px;\n        padding: 1px 4px;\n        background: #e6f7ff;\n        color: #1890ff;\n        border: 1px solid #91d5ff;\n        border-radius: 3px;\n        font-weight: normal;\n        -webkit-background-clip: unset;\n        -webkit-text-fill-color: unset;\n        background-clip: unset;\n      }\n    }\n    \n    .status-badge {\n      font-size: 10px;\n      padding: 2px 6px;\n      background: #f0f0f0;\n      color: #999;\n      border-radius: 4px;\n      margin-left: 8px;\n    }\n  }\n  \n  // 未启用通道的样式\n  &.disabled-channel {\n    .product-info {\n      .channel-name {\n        color: #999;\n        background: none;\n        -webkit-background-clip: unset;\n        -webkit-text-fill-color: unset;\n        background-clip: unset;\n        \n        .weight-badge {\n          background: #f5f5f5;\n          color: #999;\n          border-color: #d9d9d9;\n        }\n      }\n    }\n  }\n}\n\n.dialog-footer {\n  text-align: right;\n}\n\n/* Transfer组件样式调整 */\n:deep(.el-transfer-panel) {\n  width: 350px;\n}\n\n:deep(.el-transfer-panel__body) {\n  height: 400px;\n}\n\n:deep(.el-transfer-panel__list) {\n  height: 350px;\n}\n\n\n</style>\n"],"names":["visible","ref","loading","saving","currentProduct","poolData","dialogTitle","computed","emit","__emit","transferData","channel","selectedProducts","value","allChannels","selectedChannels","unselectedChannels","handleTransferChange","direction","movedKeys","open","product","loadPoolData","_a","url","res","getPoolList","status","responseData","ElMessage","error","handleSave","ElMessageBox","updatePool","handleClose","watch","newVal","__expose","_createBlock","_component_el_dialog","$event","_createElementVNode","_hoisted_9","_createVNode","_component_el_button","_cache","_withDirectives","_openBlock","_createElementBlock","_hoisted_1","_component_el_alert","_hoisted_2","_component_el_card","_hoisted_3","_createTextVNode","_toDisplayString","_hoisted_4","_component_el_transfer","_withCtx","option","_normalizeClass","_hoisted_5","_hoisted_6","_hoisted_7","_hoisted_8"],"mappings":"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"}