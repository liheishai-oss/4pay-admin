import{s as S,d as ee,g as f,a9 as ae,aj as te,i as j,w as n,D as m,ao as le,o as c,Q as oe,c as y,a as l,u as re,x as ne,ap as se,n as d,y as ue,z as ie,E as de,b as me,ar as pe,M as D,as as q,at as _e,e as h,t as fe,X as ce,a3 as ve,j as ge,q as be,au as ye,_ as Ve}from"./index-BwnaPa-Z.js";/* empty css                *//* empty css                     *//* empty css               */import{g as we}from"./supplier-57ken86U.js";function xe(v,p){return S({url:`${v}/${p}`,method:"get"})}function Ne(v,p={}){return S({url:`${v}`,method:"post",data:p})}function Ee(v,p={}){return S({url:`${v}`,method:"post",data:p})}const he={"element-loading-text":"加载中..."},Se={class:"basic-params-container"},ke={key:0,class:"no-params-tip"},Ce=ee({__name:"edit",emits:["refresh"],setup(v,{expose:p,emit:F}){const g=f(!1),k=f(),b=f(!1),o=f({id:0,channel_name:"",supplier_id:void 0,product_code:"",status:1,weight:0,min_amount:1,max_amount:0,cost_rate:0,remark:"",basic_params:[]}),u=f([]),V=f(""),P=ae(()=>{console.log("allSuppliers.value:",u.value),console.log("allSuppliers.value 类型:",typeof u.value),console.log("allSuppliers.value 是否为数组:",Array.isArray(u.value));let t=u.value.filter(a=>(console.log("检查供应商:",a,"有id:",!!(a!=null&&a.id),"有name:",!!(a!=null&&a.name)),a&&typeof a=="object"&&a.id&&a.name));if(console.log("过滤后的供应商:",t),V.value&&V.value.trim()!==""){const a=V.value.trim().toLowerCase();t=t.filter(r=>r.name.toLowerCase().includes(a))}const e=t.map(a=>({id:a.id,name:a.name}));return console.log("最终返回的供应商:",e),e}),B=async()=>{try{const t=await we("/api/v1/admin/supplier/select/all",1,1e3,{status:1});if(console.log("供应商列表API响应:",t.data),t.data&&t.data.status&&t.data.data&&Array.isArray(t.data.data)){const e=t.data.data;console.log("供应商数据:",e);const a=(Array.isArray(e)?e:[]).filter(r=>r&&typeof r=="object"&&r.id&&r.name);u.value=a,console.log("过滤后的供应商选项:",u.value)}else if(t.data&&Array.isArray(t.data)){const e=t.data;console.log("供应商数据:",e);const a=(Array.isArray(e)?e:[]).filter(r=>r&&typeof r=="object"&&r.id&&r.name);u.value=a,console.log("过滤后的供应商选项:",u.value)}else console.log("供应商列表获取失败，响应数据:",t.data),m.error("获取供应商列表失败：数据格式不正确"),u.value=[];o.value.supplier_id&&u.value.length>0&&(u.value.find(a=>a.id===o.value.supplier_id)||(console.warn("当前选中的供应商已不存在，清空选择"),o.value.supplier_id=void 0,m.warning("当前选中的供应商已不存在，请重新选择")))}catch(t){console.error("获取供应商列表失败:",t),m.error("获取供应商列表失败"),u.value=[]}},$=t=>{V.value=t},C=t=>(t/100).toFixed(2),A=t=>Math.round(parseFloat(t)*100),z=t=>(t/100).toFixed(2),I=t=>Math.round(parseFloat(t)*100),O=()=>{o.value.basic_params.push({key:"",value:""})},R=t=>{o.value.basic_params.splice(t,1)},L=t=>{const e={};return t.forEach(a=>{a.key&&a.key.trim()&&(e[a.key.trim()]=a.value||"")}),Object.keys(e).length>0?e:null},M=t=>!t||typeof t!="object"?[]:Object.entries(t).map(([e,a])=>({key:e,value:a})),T=F,G=f({channel_name:[{required:!0,message:"请输入通道名称",trigger:"blur"}],supplier_id:[{required:!0,message:"请选择供应商",trigger:"change"}],product_code:[{required:!1,message:"请输入产品编码",trigger:"blur"}],weight:[{required:!1,message:"请输入权重",trigger:"blur",validator:(t,e,a)=>{e&&(isNaN(Number(e))||Number(e)<0)?a(new Error("请输入有效的权重值")):a()}}],min_amount:[{required:!0,message:"请输入最小支付金额",trigger:"blur",validator:(t,e,a)=>{!e||isNaN(Number(e))||Number(e)<1?a(new Error("最小支付金额不能少于1元")):a()}}],max_amount:[{required:!1,message:"请输入最大支付金额",trigger:"blur",validator:(t,e,a)=>{e&&(isNaN(Number(e))||Number(e)<0)?a(new Error("请输入有效的最大支付金额")):e&&Number(e)>0&&Number(e)<o.value.min_amount?a(new Error("最大支付金额不能小于最小支付金额")):a()}}],cost_rate:[{required:!1,message:"请输入成本费率",trigger:"blur",validator:(t,e,a)=>{e&&(isNaN(Number(e))||Number(e)<0)?a(new Error("请输入有效的成本费率")):a()}}]}),K=async(t={})=>{U(),b.value=!0;try{const e=t||{};let a={...e};if(e&&e.id&&typeof e.id=="number"&&e.id>0)try{const r=await xe("/api/v1/admin/payment-channel/detail",e.id);if(r.status&&r.data)a={...r.data};else{m.error("获取通道详情失败");return}}catch{m.error("获取通道详情失败");return}e&&e.id&&typeof e.id=="number"&&e.id>0&&(a.min_amount&&(a.min_amount=C(a.min_amount)),a.max_amount&&(a.max_amount=C(a.max_amount)),a.cost_rate&&(a.cost_rate=z(a.cost_rate)),a.basic_params&&(a.basic_params=M(a.basic_params))),Object.keys(a).forEach(r=>{a[r]!==void 0&&a[r]!==null&&a[r]!==""&&(o.value[r]=a[r])}),(!e||!e.id||e.id<=0)&&(o.value.id=0,o.value.status=1,o.value.weight=0,o.value.min_amount=1,o.value.max_amount=0,o.value.cost_rate=0,o.value.basic_params=[],o.value.supplier_id=void 0),await B(),g.value=!0}catch{m.error("加载数据失败")}finally{b.value=!1}},Q=async()=>{var t,e;try{await((t=k.value)==null?void 0:t.validate());const a={...o.value};a.min_amount=A(a.min_amount.toString()),a.max_amount=A(a.max_amount.toString()),a.cost_rate=I(((e=a.cost_rate)==null?void 0:e.toString())||"0"),a.basic_params=L(a.basic_params),b.value=!0;let r;o.value.id>0?r=await Ee("/api/v1/admin/payment-channel/edit",a):r=await Ne("/api/v1/admin/payment-channel/add",a),r.status?(m.success(r.message||"操作成功"),T("refresh"),g.value=!1):m.error(r.message||"操作失败")}catch{m.error("提交失败，请检查表单信息")}finally{b.value=!1}},U=()=>{o.value={id:0,channel_name:"",supplier_id:void 0,product_code:"",status:1,weight:0,min_amount:1,max_amount:0,cost_rate:0,remark:"",basic_params:[]}};return te(g,(t,e)=>{e===!0&&t===!1&&U()}),p({open:K}),(t,e)=>{const a=se,r=ie,i=ue,X=_e,H=pe,_=me,w=de,J=ce,W=ve,x=be,Y=le,Z=ye;return c(),j(Y,{modelValue:g.value,"onUpdate:modelValue":e[10]||(e[10]=s=>g.value=s),title:o.value.id>0?"编辑收款通道":"新增收款通道",size:"50%"},{default:n(()=>[oe((c(),y("div",he,[l(re(ne),{model:o.value,rules:G.value,ref_key:"formRef",ref:k,"label-width":"150px"},{default:n(()=>[l(a,{"content-position":"left"},{default:n(()=>[...e[11]||(e[11]=[d("基本信息",-1)])]),_:1}),l(i,{label:"通道名称",prop:"channel_name"},{default:n(()=>[l(r,{modelValue:o.value.channel_name,"onUpdate:modelValue":e[0]||(e[0]=s=>o.value.channel_name=s),placeholder:"请输入通道名称"},null,8,["modelValue"])]),_:1}),l(w,{gutter:20},{default:n(()=>[l(_,{span:12},{default:n(()=>[l(i,{label:"所属供应商",prop:"supplier_id"},{default:n(()=>[l(H,{modelValue:o.value.supplier_id,"onUpdate:modelValue":e[1]||(e[1]=s=>o.value.supplier_id=s),placeholder:"请选择供应商",style:{width:"100%"},filterable:"","filter-method":$,clearable:""},{default:n(()=>[(c(!0),y(D,null,q(P.value,s=>(c(),j(X,{key:s.id,value:s.id,label:s.name,onClick:E=>console.log("选择供应商:",s)},{default:n(()=>[h("span",null,fe(s.name),1)]),_:2},1032,["value","label","onClick"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(_,{span:12},{default:n(()=>[l(i,{label:"产品编码",prop:"product_code"},{default:n(()=>[l(r,{modelValue:o.value.product_code,"onUpdate:modelValue":e[2]||(e[2]=s=>o.value.product_code=s),placeholder:"请输入产品编码（选填）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(w,{gutter:20},{default:n(()=>[l(_,{span:12},{default:n(()=>[l(i,{label:"状态",prop:"status"},{default:n(()=>[l(J,{modelValue:o.value.status,"onUpdate:modelValue":e[3]||(e[3]=s=>o.value.status=s),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1})]),_:1}),l(_,{span:12},{default:n(()=>[l(i,{label:"权重",prop:"weight"},{default:n(()=>[l(W,{modelValue:o.value.weight,"onUpdate:modelValue":e[4]||(e[4]=s=>o.value.weight=s),min:0,max:9999,placeholder:"权重越大优先级越高（选填）",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(i,{label:"备注"},{default:n(()=>[l(r,{modelValue:o.value.remark,"onUpdate:modelValue":e[5]||(e[5]=s=>o.value.remark=s),type:"textarea",placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),l(a,{"content-position":"left"},{default:n(()=>[...e[12]||(e[12]=[d("金额限制",-1)])]),_:1}),l(w,{gutter:20},{default:n(()=>[l(_,{span:12},{default:n(()=>[l(i,{label:"最小支付金额",prop:"min_amount"},{default:n(()=>[l(r,{modelValue:o.value.min_amount,"onUpdate:modelValue":e[6]||(e[6]=s=>o.value.min_amount=s),placeholder:"单位：元，最低1元"},{append:n(()=>[...e[13]||(e[13]=[d("元",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(_,{span:12},{default:n(()=>[l(i,{label:"最大支付金额",prop:"max_amount"},{default:n(()=>[l(r,{modelValue:o.value.max_amount,"onUpdate:modelValue":e[7]||(e[7]=s=>o.value.max_amount=s),placeholder:"单位：元，0表示不限制（选填）"},{append:n(()=>[...e[14]||(e[14]=[d("元",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(a,{"content-position":"left"},{default:n(()=>[...e[15]||(e[15]=[d("费率配置",-1)])]),_:1}),l(w,{gutter:20},{default:n(()=>[l(_,{span:12},{default:n(()=>[l(i,{label:"成本费率",prop:"cost_rate"},{default:n(()=>[l(r,{modelValue:o.value.cost_rate,"onUpdate:modelValue":e[8]||(e[8]=s=>o.value.cost_rate=s),placeholder:"例如：1.5表示1.5%（选填）"},{append:n(()=>[...e[16]||(e[16]=[d("%",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(a,{"content-position":"left"},{default:n(()=>[...e[17]||(e[17]=[d("基础参数配置（选填）",-1)])]),_:1}),l(i,{label:"基础参数"},{default:n(()=>[h("div",Se,[o.value.basic_params.length===0?(c(),y("div",ke,[...e[18]||(e[18]=[h("span",{style:{color:"#999","font-size":"14px"}},"暂无基础参数，点击下方按钮添加",-1)])])):ge("",!0),(c(!0),y(D,null,q(o.value.basic_params,(s,E)=>(c(),y("div",{key:E,class:"param-row"},[l(r,{modelValue:s.key,"onUpdate:modelValue":N=>s.key=N,placeholder:"参数名",style:{width:"200px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),l(r,{modelValue:s.value,"onUpdate:modelValue":N=>s.value=N,placeholder:"参数值",style:{width:"200px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),l(x,{type:"danger",size:"small",onClick:N=>R(E)},{default:n(()=>[...e[19]||(e[19]=[d(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128)),l(x,{type:"primary",size:"small",onClick:O,style:{"margin-top":"10px"}},{default:n(()=>[...e[20]||(e[20]=[d(" 添加参数 ",-1)])]),_:1})])]),_:1}),l(i,null,{default:n(()=>[l(x,{type:"primary",onClick:Q,loading:b.value},{default:n(()=>[...e[21]||(e[21]=[d("提交",-1)])]),_:1},8,["loading"]),l(x,{onClick:e[9]||(e[9]=s=>g.value=!1)},{default:n(()=>[...e[22]||(e[22]=[d("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model","rules"])])),[[Z,b.value]])]),_:1},8,["modelValue","title"])}}}),Fe=Ve(Ce,[["__scopeId","data-v-833c2202"]]);export{Fe as default};
//# sourceMappingURL=edit-D-ZJge4p.js.map
